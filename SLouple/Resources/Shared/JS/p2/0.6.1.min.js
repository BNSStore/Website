!function(n){if("object"==typeof exports)module.exports=n();else if("function"==typeof define&&!1)define(n);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self);t.p2=n()}}(function(){return function n(t,i,r){function u(f,o){var h,s;if(!i[f]){if(!t[f]){if(h=typeof require=="function"&&require,!o&&h)return h(f,!0);if(e)return e(f,!0);throw new Error("Cannot find module '"+f+"'");}s=i[f]={exports:{}};t[f][0].call(s.exports,function(n){var i=t[f][1][n];return u(i?i:n)},s,s.exports,n,t,i,r)}return i[f].exports}for(var e=typeof require=="function"&&require,f=0;f<r.length;f++)u(r[f]);return u}({1:[function(n,t){function i(){}var r=n("./Scalar");t.exports=i;i.lineInt=function(n,t,i){i=i||0;var h=[0,0],u,f,c,e,o,l,s;return u=n[1][1]-n[0][1],f=n[0][0]-n[1][0],c=u*n[0][0]+f*n[0][1],e=t[1][1]-t[0][1],o=t[0][0]-t[1][0],l=e*t[0][0]+o*t[0][1],s=u*o-e*f,r.eq(s,0,i)||(h[0]=(o*c-f*l)/s,h[1]=(u*l-e*c)/s),h};i.segmentsIntersect=function(n,t,i,r){var u=t[0]-n[0],f=t[1]-n[1],e=r[0]-i[0],o=r[1]-i[1],s,h;return e*f-o*u==0?!1:(s=(u*(i[1]-n[1])+f*(n[0]-i[0]))/(e*f-o*u),h=(e*(n[1]-i[1])+o*(i[0]-n[0]))/(o*u-e*f),s>=0&&s<=1&&h>=0&&h<=1)}},{"./Scalar":4}],2:[function(n,t){function i(){}t.exports=i;i.area=function(n,t,i){return(t[0]-n[0])*(i[1]-n[1])-(i[0]-n[0])*(t[1]-n[1])};i.left=function(n,t,r){return i.area(n,t,r)>0};i.leftOn=function(n,t,r){return i.area(n,t,r)>=0};i.right=function(n,t,r){return i.area(n,t,r)<0};i.rightOn=function(n,t,r){return i.area(n,t,r)<=0};var r=[],u=[];i.collinear=function(n,t,f,e){var o,s;if(e){o=r;s=u;o[0]=t[0]-n[0];o[1]=t[1]-n[1];s[0]=f[0]-t[0];s[1]=f[1]-t[1];var h=o[0]*s[0]+o[1]*s[1],c=Math.sqrt(o[0]*o[0]+o[1]*o[1]),l=Math.sqrt(s[0]*s[0]+s[1]*s[1]),a=Math.acos(h/(c*l));return a<e}return i.area(n,t,f)==0};i.sqdist=function(n,t){var i=t[0]-n[0],r=t[1]-n[1];return i*i+r*r}},{}],3:[function(n,t){function i(){this.vertices=[]}function o(n,t,i,r,u){u=u||0;var f=t[1]-n[1],e=n[0]-t[0],l=f*n[0]+e*n[1],o=r[1]-i[1],h=i[0]-r[0],a=o*i[0]+h*i[1],c=f*h-o*e;return s.eq(c,0,u)?[0,0]:[(h*l-e*a)/c,(f*a-o*l)/c]}var u=n("./Line"),r=n("./Point"),s=n("./Scalar"),f,e;t.exports=i;i.prototype.at=function(n){var i=this.vertices,t=i.length;return i[n<0?n%t+t:n%t]};i.prototype.first=function(){return this.vertices[0]};i.prototype.last=function(){return this.vertices[this.vertices.length-1]};i.prototype.clear=function(){this.vertices.length=0};i.prototype.append=function(n,t,i){if(typeof t=="undefined")throw new Error("From is not given!");if(typeof i=="undefined")throw new Error("To is not given!");if(i-1<t)throw new Error("lol1");if(i>n.vertices.length)throw new Error("lol2");if(t<0)throw new Error("lol3");for(var r=t;r<i;r++)this.vertices.push(n.vertices[r])};i.prototype.makeCCW=function(){for(var n=0,t=this.vertices,i=1;i<this.vertices.length;++i)(t[i][1]<t[n][1]||t[i][1]==t[n][1]&&t[i][0]>t[n][0])&&(n=i);r.left(this.at(n-1),this.at(n),this.at(n+1))||this.reverse()};i.prototype.reverse=function(){for(var n=[],t=0,i=this.vertices.length;t!==i;t++)n.push(this.vertices.pop());this.vertices=n};i.prototype.isReflex=function(n){return r.right(this.at(n-1),this.at(n),this.at(n+1))};f=[];e=[];i.prototype.canSee=function(n,t){var h,c,o=f,s=e,i;if(r.leftOn(this.at(n+1),this.at(n),this.at(t))&&r.rightOn(this.at(n-1),this.at(n),this.at(t)))return!1;for(c=r.sqdist(this.at(n),this.at(t)),i=0;i!==this.vertices.length;++i)if((i+1)%this.vertices.length!==n&&i!==n&&r.leftOn(this.at(n),this.at(t),this.at(i+1))&&r.rightOn(this.at(n),this.at(t),this.at(i))&&(o[0]=this.at(n),o[1]=this.at(t),s[0]=this.at(i),s[1]=this.at(i+1),h=u.lineInt(o,s),r.sqdist(this.at(n),h)<c))return!1;return!0};i.prototype.copy=function(n,t,r){var f=r||new i,u;if(f.clear(),n<t)for(u=n;u<=t;u++)f.vertices.push(this.vertices[u]);else{for(u=0;u<=t;u++)f.vertices.push(this.vertices[u]);for(u=n;u<this.vertices.length;u++)f.vertices.push(this.vertices[u])}return f};i.prototype.getCutEdges=function(){for(var t,u,f=[],r=[],e=[],o=new i,s=Number.MAX_VALUE,n=0;n<this.vertices.length;++n)if(this.isReflex(n))for(t=0;t<this.vertices.length;++t)if(this.canSee(n,t)){for(r=this.copy(n,t,o).getCutEdges(),e=this.copy(t,n,o).getCutEdges(),u=0;u<e.length;u++)r.push(e[u]);r.length<s&&(f=r,s=r.length,f.push([this.at(n),this.at(t)]))}return f};i.prototype.decomp=function(){var n=this.getCutEdges();return n.length>0?this.slice(n):[this]};i.prototype.slice=function(n){var r,i,u,t,e,f;if(n.length==0)return[this];if(n instanceof Array&&n.length&&n[0]instanceof Array&&n[0].length==2&&n[0][0]instanceof Array){for(r=[this],i=0;i<n.length;i++)for(u=n[i],t=0;t<r.length;t++)if(e=r[t],f=e.slice(u),f){r.splice(t,1);r.push(f[0],f[1]);break}return r}var u=n,i=this.vertices.indexOf(u[0]),t=this.vertices.indexOf(u[1]);return i!=-1&&t!=-1?[this.copy(i,t),this.copy(t,i)]:!1};i.prototype.isSimple=function(){for(var i,n=this.vertices,t=0;t<n.length-1;t++)for(i=0;i<t-1;i++)if(u.segmentsIntersect(n[t],n[t+1],n[i],n[i+1]))return!1;for(t=1;t<n.length-2;t++)if(u.segmentsIntersect(n[0],n[n.length-1],n[t],n[t+1]))return!1;return!0};i.prototype.quickDecomp=function(n,t,u,f,e,s){var c,l;e=e||100;s=s||0;f=f||25;n=typeof n!="undefined"?n:[];t=t||[];u=u||[];var d=[0,0],g=[0,0],a=[0,0],nt=0,tt=0,p=0,it=0,w=0,b=0,k=0,v=new i,y=new i,h=this,rt=this.vertices;if(rt.length<3)return n;if(s++,s>e)return console.warn("quickDecomp: max level ("+e+") reached."),n;for(c=0;c<this.vertices.length;++c)if(h.isReflex(c)){for(t.push(h.vertices[c]),nt=tt=Number.MAX_VALUE,l=0;l<this.vertices.length;++l)r.left(h.at(c-1),h.at(c),h.at(l))&&r.rightOn(h.at(c-1),h.at(c),h.at(l-1))&&(a=o(h.at(c-1),h.at(c),h.at(l),h.at(l-1)),r.right(h.at(c+1),h.at(c),a)&&(p=r.sqdist(h.vertices[c],a),p<tt&&(tt=p,g=a,b=l))),r.left(h.at(c+1),h.at(c),h.at(l+1))&&r.rightOn(h.at(c+1),h.at(c),h.at(l))&&(a=o(h.at(c+1),h.at(c),h.at(l),h.at(l+1)),r.left(h.at(c-1),h.at(c),a)&&(p=r.sqdist(h.vertices[c],a),p<nt&&(nt=p,d=a,w=l)));if(b==(w+1)%this.vertices.length)a[0]=(g[0]+d[0])/2,a[1]=(g[1]+d[1])/2,u.push(a),c<w?(v.append(h,c,w+1),v.vertices.push(a),y.vertices.push(a),b!=0&&y.append(h,b,h.vertices.length),y.append(h,0,c+1)):(c!=0&&v.append(h,c,h.vertices.length),v.append(h,0,w+1),v.vertices.push(a),y.vertices.push(a),y.append(h,b,c+1));else{if(b>w&&(w+=this.vertices.length),it=Number.MAX_VALUE,w<b)return n;for(l=b;l<=w;++l)r.leftOn(h.at(c-1),h.at(c),h.at(l))&&r.rightOn(h.at(c+1),h.at(c),h.at(l))&&(p=r.sqdist(h.at(c),h.at(l)),p<it&&(it=p,k=l%this.vertices.length));c<k?(v.append(h,c,k+1),k!=0&&y.append(h,k,rt.length),y.append(h,0,c+1)):(c!=0&&v.append(h,c,rt.length),v.append(h,0,k+1),y.append(h,k,c+1))}return v.vertices.length<y.vertices.length?(v.quickDecomp(n,t,u,f,e,s),y.quickDecomp(n,t,u,f,e,s)):(y.quickDecomp(n,t,u,f,e,s),v.quickDecomp(n,t,u,f,e,s)),n}return n.push(this),n};i.prototype.removeCollinearPoints=function(n){for(var i=0,t=this.vertices.length-1;this.vertices.length>3&&t>=0;--t)r.collinear(this.at(t-1),this.at(t),this.at(t+1),n)&&(this.vertices.splice(t%this.vertices.length,1),t--,i++);return i}},{"./Line":1,"./Point":2,"./Scalar":4}],4:[function(n,t){function i(){}t.exports=i;i.eq=function(n,t,i){return i=i||0,Math.abs(n-t)<i}},{}],5:[function(n,t){t.exports={Polygon:n("./Polygon"),Point:n("./Point")}},{"./Point":2,"./Polygon":3}],6:[function(n,t){t.exports={name:"p2",version:"0.6.1",description:"A JavaScript 2D physics engine.",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["p2.js","p2","physics","engine","2d"],main:"./src/p2.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/p2.js.git"},bugs:{url:"https://github.com/schteppe/p2.js/issues"},licenses:[{type:"MIT"}],devDependencies:{grunt:"~0.4.0","grunt-contrib-jshint":"~0.9.2","grunt-contrib-nodeunit":"~0.1.2","grunt-contrib-uglify":"~0.4.0","grunt-contrib-watch":"~0.5.0","grunt-browserify":"~2.0.1","grunt-contrib-concat":"^0.4.0"},dependencies:{"poly-decomp":"0.1.0"}}},{}],7:[function(n,t){function r(n){this.lowerBound=i.create();n&&n.lowerBound&&i.copy(this.lowerBound,n.lowerBound);this.upperBound=i.create();n&&n.upperBound&&i.copy(this.upperBound,n.upperBound)}var i=n("../math/vec2"),f=n("../utils/Utils"),u;t.exports=r;u=i.create();r.prototype.setFromPoints=function(n,t,r,f){var s=this.lowerBound,c=this.upperBound,l,a,h,o,v,y,e;for(typeof r!="number"&&(r=0),r!==0?i.rotate(s,n[0],r):i.copy(s,n[0]),i.copy(c,s),l=Math.cos(r),a=Math.sin(r),h=1;h<n.length;h++)for(o=n[h],r!==0&&(v=o[0],y=o[1],u[0]=l*v-a*y,u[1]=a*v+l*y,o=u),e=0;e<2;e++)o[e]>c[e]&&(c[e]=o[e]),o[e]<s[e]&&(s[e]=o[e]);t&&(i.add(this.lowerBound,this.lowerBound,t),i.add(this.upperBound,this.upperBound,t));f&&(this.lowerBound[0]-=f,this.lowerBound[1]-=f,this.upperBound[0]+=f,this.upperBound[1]+=f)};r.prototype.copy=function(n){i.copy(this.lowerBound,n.lowerBound);i.copy(this.upperBound,n.upperBound)};r.prototype.extend=function(n){for(var t=2,i,r;t--;)i=n.lowerBound[t],this.lowerBound[t]>i&&(this.lowerBound[t]=i),r=n.upperBound[t],this.upperBound[t]<r&&(this.upperBound[t]=r)};r.prototype.overlaps=function(n){var r=this.lowerBound,t=this.upperBound,u=n.lowerBound,i=n.upperBound;return(u[0]<=t[0]&&t[0]<=i[0]||r[0]<=i[0]&&i[0]<=t[0])&&(u[1]<=t[1]&&t[1]<=i[1]||r[1]<=i[1]&&i[1]<=t[1])}},{"../math/vec2":31,"../utils/Utils":50}],8:[function(n,t){function i(n){this.type=n;this.result=[];this.world=null;this.boundingVolumeType=i.AABB}var u=n("../math/vec2"),r=n("../objects/Body"),f;t.exports=i;i.AABB=1;i.BOUNDING_CIRCLE=2;i.prototype.setWorld=function(n){this.world=n};i.prototype.getCollisionPairs=function(){throw new Error("getCollisionPairs must be implemented in a subclass!");};f=u.create();i.boundingRadiusCheck=function(n,t){u.sub(f,n.position,t.position);var r=u.squaredLength(f),i=n.boundingRadius+t.boundingRadius;return r<=i*i};i.aabbCheck=function(n,t){return n.getAABB().overlaps(t.getAABB())};i.prototype.boundingVolumeCheck=function(n,t){var r;switch(this.boundingVolumeType){case i.BOUNDING_CIRCLE:r=i.boundingRadiusCheck(n,t);break;case i.AABB:r=i.aabbCheck(n,t);break;default:throw new Error("Bounding volume type not recognized: "+this.boundingVolumeType);}return r};i.canCollide=function(n,t){return n.type===r.STATIC&&t.type===r.STATIC?!1:n.type===r.KINEMATIC&&t.type===r.STATIC||n.type===r.STATIC&&t.type===r.KINEMATIC?!1:n.type===r.KINEMATIC&&t.type===r.KINEMATIC?!1:n.sleepState===r.SLEEPING&&t.sleepState===r.SLEEPING?!1:n.sleepState===r.SLEEPING&&t.type===r.STATIC||t.sleepState===r.SLEEPING&&n.type===r.STATIC?!1:!0};i.NAIVE=1;i.SAP=2},{"../math/vec2":31,"../objects/Body":32}],9:[function(n,t){function i(n){r.apply(this);n=u.defaults(n,{xmin:-100,xmax:100,ymin:-100,ymax:100,nx:10,ny:10});this.xmin=n.xmin;this.ymin=n.ymin;this.xmax=n.xmax;this.ymax=n.ymax;this.nx=n.nx;this.ny=n.ny;this.binsizeX=(this.xmax-this.xmin)/this.nx;this.binsizeY=(this.ymax-this.ymin)/this.ny}var f=n("../shapes/Circle"),e=n("../shapes/Plane"),o=n("../shapes/Particle"),r=n("../collision/Broadphase"),s=n("../math/vec2"),u=n("../utils/Utils");t.exports=i;i.prototype=new r;i.prototype.constructor=i;i.prototype.getCollisionPairs=function(n){for(var y,p,h,i,tt,f,u,c,b=[],k=n.bodies,it=k.length,vt=this.binsizeX,yt=this.binsizeY,d=this.nx,l=this.ny,e=this.xmin,o=this.ymin,g=this.xmax,nt=this.ymax,a=[],v=d*l,t=0;t<v;t++)a.push([]);for(y=d/(g-e),p=l/(nt-o),t=0;t!==it;t++){var f=k[t],s=f.aabb,rt=Math.max(s.lowerBound[0],e),ut=Math.max(s.lowerBound[1],o),ft=Math.min(s.upperBound[0],g),et=Math.min(s.upperBound[1],nt),ot=Math.floor(y*(rt-e)),st=Math.floor(p*(ut-o)),ht=Math.floor(y*(ft-e)),ct=Math.floor(p*(et-o));for(i=ot;i<=ht;i++)for(u=st;u<=ct;u++){var lt=i,at=u,w=lt*(l-1)+at;w>=0&&w<v&&a[w].push(f)}}for(t=0;t!==v;t++)for(h=a[t],i=0,tt=h.length;i!==tt;i++)for(f=h[i],u=0;u!==i;u++)c=h[u],r.canCollide(f,c)&&this.boundingVolumeCheck(f,c)&&b.push(f,c);return b}},{"../collision/Broadphase":8,"../math/vec2":31,"../shapes/Circle":38,"../shapes/Particle":42,"../shapes/Plane":43,"../utils/Utils":50}],10:[function(n,t){function i(){r.call(this,r.NAIVE)}var u=n("../shapes/Circle"),f=n("../shapes/Plane"),e=n("../shapes/Shape"),o=n("../shapes/Particle"),r=n("../collision/Broadphase"),s=n("../math/vec2");t.exports=i;i.prototype=new r;i.prototype.constructor=i;i.prototype.getCollisionPairs=function(n){var e=n.bodies,o=this.result,t,s,i,u,f;for(o.length=0,t=0,s=e.length;t!==s;t++)for(i=e[t],u=0;u<t;u++)f=e[u],r.canCollide(i,f)&&this.boundingVolumeCheck(i,f)&&o.push(i,f);return o};i.prototype.aabbQuery=function(n,t,i){var f,u,r;for(i=i||[],f=n.bodies,u=0;u<f.length;u++)r=f[u],r.aabbNeedsUpdate&&r.updateAABB(),r.aabb.overlaps(t)&&i.push(r);return i}},{"../collision/Broadphase":8,"../math/vec2":31,"../shapes/Circle":38,"../shapes/Particle":42,"../shapes/Plane":43,"../shapes/Shape":45}],11:[function(n,t){function u(){this.contactEquations=[];this.frictionEquations=[];this.enableFriction=!0;this.enabledEquations=!0;this.slipForce=10;this.frictionCoefficient=.3;this.surfaceVelocity=0;this.reuseObjects=!0;this.reusableContactEquations=[];this.reusableFrictionEquations=[];this.restitution=0;this.stiffness=b.DEFAULT_STIFFNESS;this.relaxation=b.DEFAULT_RELAXATION;this.frictionStiffness=b.DEFAULT_STIFFNESS;this.frictionRelaxation=b.DEFAULT_RELAXATION;this.enableFrictionReduction=!0;this.collidingBodiesLastStep=new pt;this.contactSkinSize=.01}function ut(n,t){i.set(n.vertices[0],-t.length*.5,-t.radius);i.set(n.vertices[1],t.length*.5,-t.radius);i.set(n.vertices[2],t.length*.5,t.radius);i.set(n.vertices[3],-t.length*.5,t.radius)}function vt(n,t,u,f){for(var w,b,a,s=ui,h=fi,v=ei,y=oi,p=n,o=t.vertices,c=null,l=0;l!==o.length+1;l++){if(w=o[l%o.length],b=o[(l+1)%o.length],i.rotate(s,w,f),i.rotate(h,b,f),e(s,s,u),e(h,h,u),r(v,s,p),r(y,h,p),a=i.crossLength(v,y),c===null&&(c=a),a*c<=0)return!1;c=a}return!0}var i=n("../math/vec2"),r=i.sub,e=i.add,o=i.dot,ft=n("../utils/Utils"),pt=n("../utils/TupleDictionary"),b=n("../equations/Equation"),wt=n("../equations/ContactEquation"),bt=n("../equations/FrictionEquation"),kt=n("../shapes/Circle"),dt=n("../shapes/Convex"),f=n("../shapes/Shape"),lr=n("../objects/Body"),k=n("../shapes/Rectangle"),ht,ct,lt,at,yt;t.exports=u;var d=i.fromValues(0,1),s=i.fromValues(0,0),h=i.fromValues(0,0),c=i.fromValues(0,0),l=i.fromValues(0,0),a=i.fromValues(0,0),v=i.fromValues(0,0),y=i.fromValues(0,0),p=i.fromValues(0,0),w=i.fromValues(0,0),g=i.fromValues(0,0),nt=i.fromValues(0,0),tt=i.fromValues(0,0),it=i.fromValues(0,0),rt=i.fromValues(0,0),et=i.fromValues(0,0),ot=i.fromValues(0,0),gt=i.fromValues(0,0),ni=i.fromValues(0,0),st=[];ht=i.create();ct=i.create();u.prototype.bodiesOverlap=function(n,t){for(var i,s,e=ht,o=ct,r=0,h=n.shapes.length;r!==h;r++){var u=n.shapes[r],c=n.shapeOffsets[r],a=n.shapeAngles[r];for(n.toWorldFrame(e,c),i=0,s=t.shapes.length;i!==s;i++){var f=t.shapes[i],l=t.shapeOffsets[i],v=t.shapeAngles[i];if(t.toWorldFrame(o,l),this[u.type|f.type](n,u,e,u.angle+n.angle,t,f,o,f.angle+t.angle,!0))return!0}}return!1};u.prototype.collidedLastStep=function(n,t){var i=n.id|0,r=t.id|0;return!!this.collidingBodiesLastStep.get(i,r)};u.prototype.reset=function(){var n,t;for(this.collidingBodiesLastStep.reset(),n=this.contactEquations,t=n.length;t--;){var i=n[t],r=i.bodyA.id,u=i.bodyB.id;this.collidingBodiesLastStep.set(r,u,!0)}if(this.reuseObjects){var f=this.contactEquations,e=this.frictionEquations,o=this.reusableFrictionEquations,s=this.reusableContactEquations;ft.appendArray(s,f);ft.appendArray(o,e)}this.contactEquations.length=this.frictionEquations.length=0};u.prototype.createContactEquation=function(n,t,i,r){var u=this.reusableContactEquations.length?this.reusableContactEquations.pop():new wt(n,t);return u.bodyA=n,u.bodyB=t,u.shapeA=i,u.shapeB=r,u.restitution=this.restitution,u.firstImpact=!this.collidedLastStep(n,t),u.stiffness=this.stiffness,u.relaxation=this.relaxation,u.needsUpdate=!0,u.enabled=this.enabledEquations,u.offset=this.contactSkinSize,u};u.prototype.createFrictionEquation=function(n,t,i,r){var u=this.reusableFrictionEquations.length?this.reusableFrictionEquations.pop():new bt(n,t);return u.bodyA=n,u.bodyB=t,u.shapeA=i,u.shapeB=r,u.setSlipForce(this.slipForce),u.frictionCoefficient=this.frictionCoefficient,u.relativeVelocity=this.surfaceVelocity,u.enabled=this.enabledEquations,u.needsUpdate=!0,u.stiffness=this.frictionStiffness,u.relaxation=this.frictionRelaxation,u.contactEquations.length=0,u};u.prototype.createFrictionFromContact=function(n){var t=this.createFrictionEquation(n.bodyA,n.bodyB,n.shapeA,n.shapeB);return i.copy(t.contactPointA,n.contactPointA),i.copy(t.contactPointB,n.contactPointB),i.rotate90cw(t.t,n.normalA),t.contactEquations.push(n),t};u.prototype.createFrictionFromAverage=function(n){var r=this.contactEquations[this.contactEquations.length-1],t=this.createFrictionEquation(r.bodyA,r.bodyB,r.shapeA,r.shapeB),e=r.bodyA,o=r.bodyB,u,f;for(i.set(t.contactPointA,0,0),i.set(t.contactPointB,0,0),i.set(t.t,0,0),u=0;u!==n;u++)r=this.contactEquations[this.contactEquations.length-1-u],r.bodyA===e?(i.add(t.t,t.t,r.normalA),i.add(t.contactPointA,t.contactPointA,r.contactPointA),i.add(t.contactPointB,t.contactPointB,r.contactPointB)):(i.sub(t.t,t.t,r.normalA),i.add(t.contactPointA,t.contactPointA,r.contactPointB),i.add(t.contactPointB,t.contactPointB,r.contactPointA)),t.contactEquations.push(r);return f=1/n,i.scale(t.contactPointA,t.contactPointA,f),i.scale(t.contactPointB,t.contactPointB,f),i.normalize(t.t,t.t),i.rotate90cw(t.t,t.t),t};u.prototype[f.LINE|f.CONVEX]=u.prototype.convexLine=function(n,t,i,r,u,f,e,o,s){return s?!1:0};u.prototype[f.LINE|f.RECTANGLE]=u.prototype.lineRectangle=function(n,t,i,r,u,f,e,o,s){return s?!1:0};lt=new k(1,1);at=i.create();u.prototype[f.CAPSULE|f.CONVEX]=u.prototype[f.CAPSULE|f.RECTANGLE]=u.prototype.convexCapsule=function(n,t,r,u,f,e,o,s,h){var c=at,l,a,v,y;return(i.set(c,e.length/2,0),i.rotate(c,c,s),i.add(c,c,o),l=this.circleConvex(f,e,c,s,n,t,r,u,h,e.radius),i.set(c,-e.length/2,0),i.rotate(c,c,s),i.add(c,c,o),a=this.circleConvex(f,e,c,s,n,t,r,u,h,e.radius),h&&(l||a))?!0:(v=lt,ut(v,e),y=this.convexConvex(n,t,r,u,f,v,o,s,h),y+l+a)};u.prototype[f.CAPSULE|f.LINE]=u.prototype.lineCapsule=function(n,t,i,r,u,f,e,o,s){return s?!1:0};var ti=i.create(),ii=i.create(),ri=new k(1,1);u.prototype[f.CAPSULE|f.CAPSULE]=u.prototype.capsuleCapsule=function(n,t,r,u,f,e,o,s,h){for(var p,b,y,k,c,d,l=ti,a=ii,v=0,w=0;w<2;w++)for(i.set(l,(w===0?-1:1)*t.length/2,0),i.rotate(l,l,u),i.add(l,l,r),p=0;p<2;p++){if(i.set(a,(p===0?-1:1)*e.length/2,0),i.rotate(a,a,s),i.add(a,a,o),this.enableFrictionReduction&&(c=this.enableFriction,this.enableFriction=!1),b=this.circleCircle(n,t,l,u,f,e,a,s,h,t.radius,e.radius),this.enableFrictionReduction&&(this.enableFriction=c),h&&b)return!0;v+=b}return(this.enableFrictionReduction&&(c=this.enableFriction,this.enableFriction=!1),y=ri,ut(y,t),k=this.convexCapsule(n,y,r,u,f,e,o,s,h),this.enableFrictionReduction&&(this.enableFriction=c),h&&k)?!0:(v+=k,this.enableFrictionReduction&&(c=this.enableFriction,this.enableFriction=!1),ut(y,e),d=this.convexCapsule(f,y,o,s,n,t,r,u,h),this.enableFrictionReduction&&(this.enableFriction=c),h&&d)?!0:(v+=d,this.enableFrictionReduction&&v&&this.enableFriction&&this.frictionEquations.push(this.createFrictionFromAverage(v)),v)};u.prototype[f.LINE|f.LINE]=u.prototype.lineLine=function(n,t,i,r,u,f,e,o,s){return s?!1:0};u.prototype[f.PLANE|f.LINE]=u.prototype.planeLine=function(n,t,u,f,b,k,g,nt,tt){var rt=s,ut=h,ft=c,et=l,pt=a,wt=v,ot=y,ht=p,bt=w,ct=st,lt=0,at,vt,yt,it;for(i.set(rt,-k.length/2,0),i.set(ut,k.length/2,0),i.rotate(ft,rt,nt),i.rotate(et,ut,nt),e(ft,ft,g),e(et,et,g),i.copy(rt,ft),i.copy(ut,et),r(pt,ut,rt),i.normalize(wt,pt),i.rotate90cw(bt,wt),i.rotate(ht,d,f),ct[0]=rt,ct[1]=ut,at=0;at<ct.length;at++)if(vt=ct[at],r(ot,vt,u),yt=o(ot,ht),yt<0){if(tt)return!0;it=this.createContactEquation(n,b,t,k);lt++;i.copy(it.normalA,ht);i.normalize(it.normalA,it.normalA);i.scale(ot,ht,yt);r(it.contactPointA,vt,ot);r(it.contactPointA,it.contactPointA,n.position);r(it.contactPointB,vt,g);e(it.contactPointB,it.contactPointB,g);r(it.contactPointB,it.contactPointB,b.position);this.contactEquations.push(it);this.enableFrictionReduction||this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(it))}return tt?!1:(this.enableFrictionReduction||lt&&this.enableFriction&&this.frictionEquations.push(this.createFrictionFromAverage(lt)),lt)};u.prototype[f.PARTICLE|f.CAPSULE]=u.prototype.particleCapsule=function(n,t,i,r,u,f,e,o,s){return this.circleLine(n,t,i,r,u,f,e,o,s,f.radius,0)};u.prototype[f.CIRCLE|f.LINE]=u.prototype.circleLine=function(n,t,u,f,b,k,d,ut,ft,et,ot){var et=et||0,ot=typeof ot!="undefined"?ot:t.radius,ni=s,lt=h,vt=c,si=l,yt=a,ui=v,pt=y,ct=p,at=w,bt=g,kt=nt,wt=tt,fi=it,ei=rt,dt=st,ti,ii,gt,ri,ht;if(i.set(ct,-k.length/2,0),i.set(at,k.length/2,0),i.rotate(bt,ct,ut),i.rotate(kt,at,ut),e(bt,bt,d),e(kt,kt,d),i.copy(ct,bt),i.copy(at,kt),r(ui,at,ct),i.normalize(pt,ui),i.rotate90cw(yt,pt),r(wt,u,ct),ti=o(wt,yt),r(si,ct,d),r(fi,u,d),ii=ot+et,Math.abs(ti)<ii){i.scale(ni,yt,ti);r(vt,u,ni);i.scale(lt,yt,o(yt,fi));i.normalize(lt,lt);i.scale(lt,lt,et);e(vt,vt,lt);var oi=o(pt,vt),hi=o(pt,ct),ci=o(pt,at);if(oi>hi&&oi<ci)return ft?!0:(ht=this.createContactEquation(n,b,t,k),i.scale(ht.normalA,ni,-1),i.normalize(ht.normalA,ht.normalA),i.scale(ht.contactPointA,ht.normalA,ot),e(ht.contactPointA,ht.contactPointA,u),r(ht.contactPointA,ht.contactPointA,n.position),r(ht.contactPointB,vt,d),e(ht.contactPointB,ht.contactPointB,d),r(ht.contactPointB,ht.contactPointB,b.position),this.contactEquations.push(ht),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(ht)),1)}for(dt[0]=ct,dt[1]=at,gt=0;gt<dt.length;gt++)if(ri=dt[gt],r(wt,ri,u),i.squaredLength(wt)<Math.pow(ii,2))return ft?!0:(ht=this.createContactEquation(n,b,t,k),i.copy(ht.normalA,wt),i.normalize(ht.normalA,ht.normalA),i.scale(ht.contactPointA,ht.normalA,ot),e(ht.contactPointA,ht.contactPointA,u),r(ht.contactPointA,ht.contactPointA,n.position),r(ht.contactPointB,ri,d),i.scale(ei,ht.normalA,-et),e(ht.contactPointB,ht.contactPointB,ei),e(ht.contactPointB,ht.contactPointB,d),r(ht.contactPointB,ht.contactPointB,b.position),this.contactEquations.push(ht),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(ht)),1);return 0};u.prototype[f.CIRCLE|f.CAPSULE]=u.prototype.circleCapsule=function(n,t,i,r,u,f,e,o,s){return this.circleLine(n,t,i,r,u,f,e,o,s,f.radius)};u.prototype[f.CIRCLE|f.CONVEX]=u.prototype[f.CIRCLE|f.RECTANGLE]=u.prototype.circleConvex=function(n,t,u,f,o,b,k,d,ut,ft){for(var fi,ei,kt,oi,st,ft=typeof ft=="number"?ft:t.radius,at=s,pt=h,gt=c,ni=l,wt=a,si=v,hi=y,ci=p,li=w,dt=g,yt=nt,ai=tt,bt=it,ct=rt,ti=et,ii=ot,ri=!1,ui=Number.MAX_VALUE,lt=b.vertices,ht=0;ht!==lt.length+1;ht++)fi=lt[ht%lt.length],ei=lt[(ht+1)%lt.length],i.rotate(at,fi,d),i.rotate(pt,ei,d),e(at,at,k),e(pt,pt,k),r(gt,pt,at),i.normalize(ni,gt),i.rotate90cw(wt,ni),i.scale(ct,wt,-t.radius),e(ct,ct,u),vt(ct,b,k,d)&&(i.sub(ti,at,ct),kt=Math.abs(i.dot(ti,wt)),kt<ui&&(i.copy(ii,ct),ui=kt,i.scale(bt,wt,kt),i.add(bt,bt,ct),ri=!0));if(ri)return ut?!0:(st=this.createContactEquation(n,o,t,b),i.sub(st.normalA,ii,u),i.normalize(st.normalA,st.normalA),i.scale(st.contactPointA,st.normalA,ft),e(st.contactPointA,st.contactPointA,u),r(st.contactPointA,st.contactPointA,n.position),r(st.contactPointB,bt,k),e(st.contactPointB,st.contactPointB,k),r(st.contactPointB,st.contactPointB,o.position),this.contactEquations.push(st),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(st)),1);if(ft>0)for(ht=0;ht<lt.length;ht++)if(oi=lt[ht],i.rotate(yt,oi,d),e(yt,yt,k),r(dt,yt,u),i.squaredLength(dt)<Math.pow(ft,2))return ut?!0:(st=this.createContactEquation(n,o,t,b),i.copy(st.normalA,dt),i.normalize(st.normalA,st.normalA),i.scale(st.contactPointA,st.normalA,ft),e(st.contactPointA,st.contactPointA,u),r(st.contactPointA,st.contactPointA,n.position),r(st.contactPointB,yt,k),e(st.contactPointB,st.contactPointB,k),r(st.contactPointB,st.contactPointB,o.position),this.contactEquations.push(st),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(st)),1);return 0};var ui=i.create(),fi=i.create(),ei=i.create(),oi=i.create();u.prototype[f.PARTICLE|f.CONVEX]=u.prototype[f.PARTICLE|f.RECTANGLE]=u.prototype.particleConvex=function(n,t,u,f,b,k,d,ut,ft){var ht=s,yt=h,bt=c,kt=l,ct=a,oi=v,si=y,li=p,ai=w,dt=g,vi=nt,yi=tt,pt=it,pi=rt,wi=et,bi=ot,ti=gt,ii=ni,ri=Number.MAX_VALUE,ui=!1,lt=k.vertices,hi,at,fi,ei,ci,wt,st;if(!vt(u,k,d,ut))return 0;if(ft)return!0;for(hi=null,at=0;at!==lt.length+1;at++)fi=lt[at%lt.length],ei=lt[(at+1)%lt.length],i.rotate(ht,fi,ut),i.rotate(yt,ei,ut),e(ht,ht,d),e(yt,yt,d),r(bt,yt,ht),i.normalize(kt,bt),i.rotate90cw(ct,kt),r(dt,u,ht),ci=o(dt,ct),r(oi,ht,d),r(si,u,d),i.sub(ti,ht,u),wt=Math.abs(i.dot(ti,ct)),wt<ri&&(ri=wt,i.scale(pt,ct,wt),i.add(pt,pt,u),i.copy(ii,ct),ui=!0);return ui?(st=this.createContactEquation(n,b,t,k),i.scale(st.normalA,ii,-1),i.normalize(st.normalA,st.normalA),i.set(st.contactPointA,0,0),e(st.contactPointA,st.contactPointA,u),r(st.contactPointA,st.contactPointA,n.position),r(st.contactPointB,pt,d),e(st.contactPointB,st.contactPointB,d),r(st.contactPointB,st.contactPointB,b.position),this.contactEquations.push(st),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(st)),1):0};u.prototype[f.CIRCLE]=u.prototype.circleCircle=function(n,t,u,f,o,h,c,l,a,v,y){var w=s,v=v||t.radius,y=y||h.radius,b,p;return(r(w,u,c),b=v+y,i.squaredLength(w)>Math.pow(b,2))?0:a?!0:(p=this.createContactEquation(n,o,t,h),r(p.normalA,c,u),i.normalize(p.normalA,p.normalA),i.scale(p.contactPointA,p.normalA,v),i.scale(p.contactPointB,p.normalA,-y),e(p.contactPointA,p.contactPointA,u),r(p.contactPointA,p.contactPointA,n.position),e(p.contactPointB,p.contactPointB,c),r(p.contactPointB,p.contactPointB,o.position),this.contactEquations.push(p),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(p)),1)};u.prototype[f.PLANE|f.CONVEX]=u.prototype[f.PLANE|f.RECTANGLE]=u.prototype.planeConvex=function(n,t,u,f,l,a,v,y,p){var b=s,tt=h,k=c,g=0,nt,it,w,rt;for(i.rotate(tt,d,f),nt=0;nt!==a.vertices.length;nt++)if(it=a.vertices[nt],i.rotate(b,it,y),e(b,b,v),r(k,b,u),o(k,tt)<=0){if(p)return!0;g++;w=this.createContactEquation(n,l,t,a);r(k,b,u);i.copy(w.normalA,tt);rt=o(k,w.normalA);i.scale(k,w.normalA,rt);r(w.contactPointB,b,l.position);r(w.contactPointA,b,k);r(w.contactPointA,w.contactPointA,n.position);this.contactEquations.push(w);this.enableFrictionReduction||this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(w))}return this.enableFrictionReduction&&this.enableFriction&&g&&this.frictionEquations.push(this.createFrictionFromAverage(g)),g};u.prototype[f.PARTICLE|f.PLANE]=u.prototype.particlePlane=function(n,t,u,f,e,c,l,a,v){var p=s,w=h,b,y;return(a=a||0,r(p,u,l),i.rotate(w,d,a),b=o(p,w),b>0)?0:v?!0:(y=this.createContactEquation(e,n,c,t),i.copy(y.normalA,w),i.scale(p,y.normalA,b),r(y.contactPointA,u,p),r(y.contactPointA,y.contactPointA,e.position),r(y.contactPointB,u,n.position),this.contactEquations.push(y),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(y)),1)};u.prototype[f.CIRCLE|f.PARTICLE]=u.prototype.circleParticle=function(n,t,u,f,o,h,c,l,a){var y=s,v;return(r(y,c,u),i.squaredLength(y)>Math.pow(t.radius,2))?0:a?!0:(v=this.createContactEquation(n,o,t,h),i.copy(v.normalA,y),i.normalize(v.normalA,v.normalA),i.scale(v.contactPointA,v.normalA,t.radius),e(v.contactPointA,v.contactPointA,u),r(v.contactPointA,v.contactPointA,n.position),r(v.contactPointB,c,o.position),this.contactEquations.push(v),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(v)),1)};var si=new kt(1),hi=i.create(),ci=i.create(),li=i.create();u.prototype[f.PLANE|f.CAPSULE]=u.prototype.planeCapsule=function(n,t,r,u,f,o,s,h,c){var l=hi,a=ci,y=si,k=li,b,p,w,v;return i.set(l,-o.length/2,0),i.rotate(l,l,h),e(l,l,s),i.set(a,o.length/2,0),i.rotate(a,a,h),e(a,a,s),y.radius=o.radius,this.enableFrictionReduction&&(b=this.enableFriction,this.enableFriction=!1),p=this.circlePlane(f,y,l,0,n,t,r,u,c),w=this.circlePlane(f,y,a,0,n,t,r,u,c),this.enableFrictionReduction&&(this.enableFriction=b),c?p||w:(v=p+w,this.enableFrictionReduction&&v&&this.frictionEquations.push(this.createFrictionFromAverage(v)),v)};u.prototype[f.CIRCLE|f.PLANE]=u.prototype.circlePlane=function(n,t,u,f,l,a,v,y,p){var tt=n,it=t,rt=u,ut=l,ot=a,ft=v,b=y,nt,w;b=b||0;var k=s,g=h,et=c;return(r(k,rt,ft),i.rotate(g,d,b),nt=o(g,k),nt>it.radius)?0:p?!0:(w=this.createContactEquation(ut,tt,a,t),i.copy(w.normalA,g),i.scale(w.contactPointB,w.normalA,-it.radius),e(w.contactPointB,w.contactPointB,rt),r(w.contactPointB,w.contactPointB,tt.position),i.scale(et,w.normalA,nt),r(w.contactPointA,k,et),e(w.contactPointA,w.contactPointA,ft),r(w.contactPointA,w.contactPointA,ut.position),this.contactEquations.push(w),this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(w)),1)};u.prototype[f.CONVEX]=u.prototype[f.CONVEX|f.RECTANGLE]=u.prototype[f.RECTANGLE]=u.prototype.convexConvex=function(n,t,f,b,k,d,g,nt,tt,it){var at=s,ct=h,ft=c,ot=l,kt=a,yi=v,li=y,vt=p,dt=w,gt=0,it=typeof it=="number"?it:0,vi=u.findSeparatingAxis(t,f,b,d,g,nt,at),oi,si,ni,et,ui,ai,ci,lt,rt,fi,ei,bt;if(!vi||(r(vt,g,f),o(at,vt)>0&&i.scale(at,at,-1),oi=u.getClosestEdge(t,b,at,!0),si=u.getClosestEdge(d,nt,at),oi===-1||si===-1))return 0;for(ni=0;ni<2;ni++){var st=oi,ti=si,ut=t,yt=d,ht=f,wt=g,pt=b,hi=nt,ii=n,ri=k;for(ni===0&&(et=st,st=ti,ti=et,et=ut,ut=yt,yt=et,et=ht,ht=wt,wt=et,et=pt,pt=hi,hi=et,et=ii,ii=ri,ri=et),ui=ti;ui<ti+2;ui++){for(ai=yt.vertices[(ui+yt.vertices.length)%yt.vertices.length],i.rotate(ct,ai,hi),e(ct,ct,wt),ci=0,lt=st-1;lt<st+2;lt++)fi=ut.vertices[(lt+ut.vertices.length)%ut.vertices.length],ei=ut.vertices[(lt+1+ut.vertices.length)%ut.vertices.length],i.rotate(ft,fi,pt),i.rotate(ot,ei,pt),e(ft,ft,ht),e(ot,ot,ht),r(kt,ot,ft),i.rotate90cw(dt,kt),i.normalize(dt,dt),r(vt,ct,ft),bt=o(dt,vt),(lt===st&&bt<=it||lt!==st&&bt<=0)&&ci++;if(ci>=3){if(tt)return!0;rt=this.createContactEquation(ii,ri,ut,yt);gt++;fi=ut.vertices[st%ut.vertices.length];ei=ut.vertices[(st+1)%ut.vertices.length];i.rotate(ft,fi,pt);i.rotate(ot,ei,pt);e(ft,ft,ht);e(ot,ot,ht);r(kt,ot,ft);i.rotate90cw(rt.normalA,kt);i.normalize(rt.normalA,rt.normalA);r(vt,ct,ft);bt=o(rt.normalA,vt);i.scale(li,rt.normalA,bt);r(rt.contactPointA,ct,ht);r(rt.contactPointA,rt.contactPointA,li);e(rt.contactPointA,rt.contactPointA,ht);r(rt.contactPointA,rt.contactPointA,ii.position);r(rt.contactPointB,ct,wt);e(rt.contactPointB,rt.contactPointB,wt);r(rt.contactPointB,rt.contactPointB,ri.position);this.contactEquations.push(rt);this.enableFrictionReduction||this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(rt))}}}return this.enableFrictionReduction&&this.enableFriction&&gt&&this.frictionEquations.push(this.createFrictionFromAverage(gt)),gt};yt=i.fromValues(0,0);u.projectConvexOntoAxis=function(n,t,r,u,f){var e=null,s=null,a,h,v=yt,c,y,l;for(i.rotate(v,u,-r),c=0;c<n.vertices.length;c++)a=n.vertices[c],h=o(a,v),(e===null||h>e)&&(e=h),(s===null||h<s)&&(s=h);s>e&&(y=s,s=e,e=y);l=o(t,u);i.set(f,s+l,e+l)};var ai=i.fromValues(0,0),vi=i.fromValues(0,0),yi=i.fromValues(0,0),pi=i.fromValues(0,0),wi=i.fromValues(0,0),bi=i.fromValues(0,0);u.findSeparatingAxis=function(n,t,f,e,o,s,h){var d=null,g=!1,it=!1,rt=ai,ut=vi,ft=yi,c=pi,a=wi,v=bi,y,p,w,l,b;if(n instanceof k&&e instanceof k)for(y=0;y!==2;y++)for(p=n,w=f,y===1&&(p=e,w=s),l=0;l!==2;l++){l===0?i.set(c,0,1):l===1&&i.set(c,1,0);w!==0&&i.rotate(c,c,w);u.projectConvexOntoAxis(n,t,f,c,a);u.projectConvexOntoAxis(e,o,s,c,v);var nt=a,tt=v,et=!1;a[0]>v[0]&&(tt=a,nt=v,et=!0);b=tt[0]-nt[1];g=b<=0;(d===null||b>d)&&(i.copy(h,c),d=b,it=g)}else for(y=0;y!==2;y++)for(p=n,w=f,y===1&&(p=e,w=s),l=0;l!==p.vertices.length;l++){i.rotate(ut,p.vertices[l],w);i.rotate(ft,p.vertices[(l+1)%p.vertices.length],w);r(rt,ft,ut);i.rotate90cw(c,rt);i.normalize(c,c);u.projectConvexOntoAxis(n,t,f,c,a);u.projectConvexOntoAxis(e,o,s,c,v);var nt=a,tt=v,et=!1;a[0]>v[0]&&(tt=a,nt=v,et=!0);b=tt[0]-nt[1];g=b<=0;(d===null||b>d)&&(i.copy(h,c),d=b,it=g)}return it};var ki=i.fromValues(0,0),di=i.fromValues(0,0),gi=i.fromValues(0,0);u.getClosestEdge=function(n,t,u,f){var s=ki,v=di,h=gi,e,a;i.rotate(s,u,-t);f&&i.scale(s,s,-1);var l=-1,c=n.vertices.length,y=-1;for(e=0;e!==c;e++)r(v,n.vertices[(e+1)%c],n.vertices[e%c]),i.rotate90cw(h,v),i.normalize(h,h),a=o(h,s),(l===-1||a>y)&&(l=e%c,y=a);return l};var nr=i.create(),tr=i.create(),ir=i.create(),rr=i.create(),ur=i.create(),fr=i.create(),er=i.create();u.prototype[f.CIRCLE|f.HEIGHTFIELD]=u.prototype.circleHeightfield=function(n,t,u,f,o,s,h,c,l,a){var p=s.data,a=a||t.radius,tt=s.elementWidth,k=tr,d=nr,ot=ur,st=er,b=fr,w=ir,it=rr,g=Math.floor((u[0]-a-h[0])/tt),nt=Math.ceil((u[0]+a-h[0])/tt),ut,ft,rt,et,y,v;for(g<0&&(g=0),nt>=p.length&&(nt=p.length-1),ut=p[g],ft=p[nt],y=g;y<nt;y++)p[y]<ft&&(ft=p[y]),p[y]>ut&&(ut=p[y]);if(u[1]-a>ut)return l?!1:0;for(rt=!1,y=g;y<nt;y++)if(i.set(w,y*tt,p[y]),i.set(it,(y+1)*tt,p[y+1]),i.add(w,w,h),i.add(it,it,h),i.sub(b,it,w),i.rotate(b,b,Math.PI/2),i.normalize(b,b),i.scale(d,b,-a),i.add(d,d,u),i.sub(k,d,w),et=i.dot(k,b),d[0]>=w[0]&&d[0]<it[0]&&et<=0){if(l)return!0;rt=!0;i.scale(k,b,-et);i.add(ot,d,k);i.copy(st,b);v=this.createContactEquation(o,n,s,t);i.copy(v.normalA,st);i.scale(v.contactPointB,v.normalA,-a);e(v.contactPointB,v.contactPointB,u);r(v.contactPointB,v.contactPointB,n.position);i.copy(v.contactPointA,ot);i.sub(v.contactPointA,v.contactPointA,o.position);this.contactEquations.push(v);this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(v))}if(rt=!1,a>0)for(y=g;y<=nt;y++)if(i.set(w,y*tt,p[y]),i.add(w,w,h),i.sub(k,u,w),i.squaredLength(k)<Math.pow(a,2)){if(l)return!0;rt=!0;v=this.createContactEquation(o,n,s,t);i.copy(v.normalA,k);i.normalize(v.normalA,v.normalA);i.scale(v.contactPointB,v.normalA,-a);e(v.contactPointB,v.contactPointB,u);r(v.contactPointB,v.contactPointB,n.position);r(v.contactPointA,w,h);e(v.contactPointA,v.contactPointA,h);r(v.contactPointA,v.contactPointA,o.position);this.contactEquations.push(v);this.enableFriction&&this.frictionEquations.push(this.createFrictionFromContact(v))}return rt?1:0};var or=i.create(),sr=i.create(),hr=i.create(),cr=new dt([i.create(),i.create(),i.create(),i.create()]);u.prototype[f.RECTANGLE|f.HEIGHTFIELD]=u.prototype[f.CONVEX|f.HEIGHTFIELD]=u.prototype.convexHeightfield=function(n,t,r,u,f,e,o,s,h){var l=e.data,b=e.elementWidth,v=or,y=sr,k=hr,a=cr,p=Math.floor((n.aabb.lowerBound[0]-o[0])/b),w=Math.ceil((n.aabb.upperBound[0]-o[0])/b),d,nt,it,tt,c,g;for(p<0&&(p=0),w>=l.length&&(w=l.length-1),d=l[p],nt=l[w],c=p;c<w;c++)l[c]<nt&&(nt=l[c]),l[c]>d&&(d=l[c]);if(n.aabb.lowerBound[1]>d)return h?!1:0;for(it=!1,tt=0,c=p;c<w;c++)i.set(v,c*b,l[c]),i.set(y,(c+1)*b,l[c+1]),i.add(v,v,o),i.add(y,y,o),g=100,i.set(k,(y[0]+v[0])*.5,(y[1]+v[1]-g)*.5),i.sub(a.vertices[0],y,k),i.sub(a.vertices[1],v,k),i.copy(a.vertices[2],a.vertices[1]),i.copy(a.vertices[3],a.vertices[0]),a.vertices[2][1]-=g,a.vertices[3][1]-=g,tt+=this.convexConvex(n,t,r,u,f,a,k,0,h);return tt}},{"../equations/ContactEquation":22,"../equations/Equation":23,"../equations/FrictionEquation":24,"../math/vec2":31,"../objects/Body":32,"../shapes/Circle":38,"../shapes/Convex":39,"../shapes/Rectangle":44,"../shapes/Shape":45,"../utils/TupleDictionary":49,"../utils/Utils":50}],12:[function(n,t){function r(n){n=n||{};this.from=n.from?i.fromValues(n.from[0],n.from[1]):i.create();this.to=n.to?i.fromValues(n.to[0],n.to[1]):i.create();this._direction=i.create();this.precision=.0001;this.checkCollisionResponse=!0;this.skipBackfaces=!1;this.collisionMask=-1;this.collisionGroup=-1;this.mode=r.ANY;this.result=new e;this.hasHit=!1;this.callback=function(){}}function ft(n,t,r){var f;return i.sub(h,r,n),f=i.dot(h,t),i.scale(u,t,f),i.add(u,u,n),i.distance(r,u)}var s,f,c,l,h,u;t.exports=r;var i=n("../math/vec2"),e=n("../collision/RaycastResult"),o=n("../shapes/Shape"),a=n("../collision/AABB");r.prototype.constructor=r;r.CLOSEST=1;r.ANY=2;r.ALL=4;s=new a;f=[];r.prototype.intersectWorld=function(n,t){return this.mode=t.mode||r.ANY,this.result=t.result||new e,this.skipBackfaces=!!t.skipBackfaces,this.collisionMask=typeof t.collisionMask!="undefined"?t.collisionMask:-1,this.collisionGroup=typeof t.collisionGroup!="undefined"?t.collisionGroup:-1,t.from&&i.copy(this.from,t.from),t.to&&i.copy(this.to,t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(s),f.length=0,n.broadphase.aabbQuery(n,s,f),this.intersectBodies(f),this.hasHit};var et=i.create(),ot=i.create(),v=i.create();r.prototype.intersectBody=function(n,t){var f,r,u,o,e,s;if(t&&(this.result=t,this._updateDirection()),f=this.checkCollisionResponse,!f||n.collisionResponse)for(r=v,u=0,o=n.shapes.length;u<o;u++)if((e=n.shapes[u],!f||e.collisionResponse)&&(i.copy(r,n.shapeOffsets[u]),i.rotate(r,r,n.angle),i.add(r,r,n.position),s=n.shapeAngles[u]+n.angle,this.intersectShape(e,s,r,n),this.result._shouldStop))break};r.prototype.intersectBodies=function(n,t){t&&(this.result=t,this._updateDirection());for(var i=0,r=n.length;!this.result._shouldStop&&i<r;i++)this.intersectBody(n[i])};r.prototype._updateDirection=function(){var n=this._direction;i.sub(n,this.to,this.from);i.normalize(n,n)};r.prototype.intersectShape=function(n,t,i,r){var f=this.from,e=ft(f,this._direction,i),u;e>n.boundingSphereRadius||(u=this[n.type],u&&u.call(this,n,t,i,r))};var st=i.create(),ht=i.create(),ct=i.create(),lt=i.create(),at=i.create(),vt=i.create(),yt=i.create(),pt=new e,y=i.create(),p=i.create(),w=i.create(),b=i.create(),k=i.create(),d=i.create(),g=i.create();r.prototype.intersectRectangle=function(n,t,r,u){var f=-Number.MAX_VALUE,e=Number.MAX_VALUE,o=y,s=p,c=w,l=b,h=k,rt=d,ut=g,nt;if(i.set(rt,-n.width*.5,-n.height*.5),i.set(ut,n.width*.5,n.height*.5),i.rotate(o,this._direction,-t),u.toLocalFrame(s,this.from),o[0]!==0){var a=(rt[0]-s[0])/o[0],v=(ut[0]-s[0])/o[0],ft=f;f=Math.max(f,Math.min(a,v));f!==ft&&i.set(c,a>v?1:-1,0);nt=e;e=Math.min(e,Math.max(a,v));e!==nt&&i.set(l,a<v?1:-1,0)}if(o[1]!==0){var tt=(rt[1]-s[1])/o[1],it=(ut[1]-s[1])/o[1],ft=f;f=Math.max(f,Math.min(tt,it));f!==ft&&i.set(c,0,tt>it?1:-1);nt=e;e=Math.min(e,Math.max(tt,it));e!==nt&&i.set(l,0,tt<it?1:-1)}if(e>=f){if(i.set(h,s[0]+o[0]*f,s[1]+o[1]*f),i.rotate(c,c,t),u.toWorldFrame(h,h),this.reportIntersection(c,h,n,u,-1),this._shouldStop)return;i.rotate(l,l,t);i.set(h,s[0]+o[0]*e,s[1]+o[1]*e);u.toWorldFrame(h,h);this.reportIntersection(l,h,n,u,-1)}};r.prototype[o.RECTANGLE]=r.prototype.intersectRectangle;var nt=i.create(),tt=i.create(),it=i.create(),rt=i.create(),ut=i.create();r.prototype.intersectPlane=function(n,t,r,u){var e=this.from,h=this.to,c=this._direction,l=nt,a=tt,v=it,f=rt,o=ut,s,y,p,w;(i.set(f,0,1),i.rotate(f,f,t),i.sub(o,e,r),s=i.dot(o,f),i.sub(o,h,r),y=i.dot(o,f),s*y>0)||i.distance(e,h)<s||(p=i.dot(f,c),i.sub(l,e,r),w=-i.dot(f,l)/p,i.scale(a,c,w),i.add(v,e,a),this.reportIntersection(f,v,n,u,-1))};r.prototype[o.PLANE]=r.prototype.intersectPlane;c=i.create();l=i.create();r.prototype.intersectCircle=function(n,t,r,u){var e=this.from,s=this.to,w=n.radius,a=Math.pow(s[0]-e[0],2)+Math.pow(s[1]-e[1],2),v=2*((s[0]-e[0])*(e[0]-r[0])+(s[1]-e[1])*(e[1]-r[1])),b=Math.pow(e[0]-r[0],2)+Math.pow(e[1]-r[1],2)-Math.pow(w,2),h=Math.pow(v,2)-4*a*b,o=c,f=l,y,p;if(!(h<0))if(h===0)i.lerp(o,e,s,h),i.sub(f,o,r),i.normalize(f,f),this.reportIntersection(f,o,n,u,-1);else{if(y=(-v-Math.sqrt(h))/(2*a),p=(-v+Math.sqrt(h))/(2*a),i.lerp(o,e,s,y),i.sub(f,o,r),i.normalize(f,f),this.reportIntersection(f,o,n,u,-1),this.result._shouldStop)return;i.lerp(o,e,s,p);i.sub(f,o,r);i.normalize(f,f);this.reportIntersection(f,o,n,u,-1)}};r.prototype[o.CIRCLE]=r.prototype.intersectCircle;r.prototype.getAABB=function(n){var t=this.to,i=this.from;n.lowerBound[0]=Math.min(t[0],i[0]);n.lowerBound[1]=Math.min(t[1],i[1]);n.upperBound[0]=Math.max(t[0],i[0]);n.upperBound[1]=Math.max(t[1],i[1])};r.prototype.reportIntersection=function(n,t,u,f,e){var s=this.from,c=this.to,h=i.distance(s,t),o=this.result;if(!this.skipBackfaces||!(i.dot(n,this._direction)>0)){o.hitFaceIndex=typeof e!="undefined"?e:-1;switch(this.mode){case r.ALL:this.hasHit=!0;o.set(s,c,n,t,u,f,h);o.hasHit=!0;this.callback(o);break;case r.CLOSEST:(h<o.distance||!o.hasHit)&&(this.hasHit=!0,o.hasHit=!0,o.set(s,c,n,t,u,f,h));break;case r.ANY:this.hasHit=!0;o.hasHit=!0;o.set(s,c,n,t,u,f,h);o._shouldStop=!0}}};h=i.create();u=i.create()},{"../collision/AABB":7,"../collision/RaycastResult":13,"../math/vec2":31,"../shapes/Shape":45}],13:[function(n,t){function r(){this.rayFromWorld=i.create();this.rayToWorld=i.create();this.hitNormalWorld=i.create();this.hitPointWorld=i.create();this.hasHit=!1;this.shape=null;this.body=null;this.hitFaceIndex=-1;this.distance=-1;this._shouldStop=!1}var i=n("../math/vec2");t.exports=r;r.prototype.reset=function(){i.set(this.rayFromWorld,0,0);i.set(this.rayToWorld,0,0);i.set(this.hitNormalWorld,0,0);i.set(this.hitPointWorld,0,0);this.hasHit=!1;this.shape=null;this.body=null;this.hitFaceIndex=-1;this.distance=-1;this._shouldStop=!1};r.prototype.abort=function(){this._shouldStop=!0};r.prototype.set=function(n,t,r,u,f,e,o){i.copy(this.rayFromWorld,n);i.copy(this.rayToWorld,t);i.copy(this.hitNormalWorld,r);i.copy(this.hitPointWorld,u);this.shape=f;this.body=e;this.distance=o}},{"../math/vec2":31}],14:[function(n,t){function i(){r.call(this,r.SAP);this.axisList=[];this.axisIndex=0;var n=this;this._addBodyHandler=function(t){n.axisList.push(t.body)};this._removeBodyHandler=function(t){var i=n.axisList.indexOf(t.body);i!==-1&&n.axisList.splice(i,1)}}var u=n("../utils/Utils"),r=n("../collision/Broadphase");t.exports=i;i.prototype=new r;i.prototype.constructor=i;i.prototype.setWorld=function(n){this.axisList.length=0;u.appendArray(this.axisList,n.bodies);n.off("addBody",this._addBodyHandler).off("removeBody",this._removeBodyHandler);n.on("addBody",this._addBodyHandler).on("removeBody",this._removeBodyHandler);this.world=n};i.sortAxisList=function(n,t){var r,f,u,i;for(t=t|0,r=1,f=n.length;r<f;r++){for(u=n[r],i=r-1;i>=0;i--){if(n[i].aabb.lowerBound[t]<=u.aabb.lowerBound[t])break;n[i+1]=n[i]}n[i+1]=u}return n};i.prototype.sortList=function(){var n=this.axisList,t=this.axisIndex;i.sortAxisList(n,t)};i.prototype.getCollisionPairs=function(){var n=this.axisList,e=this.result,c=this.axisIndex,o,s,t,h,i,f,u,l;for(e.length=0,o=n.length;o--;)s=n[o],s.aabbNeedsUpdate&&s.updateAABB();for(this.sortList(),t=0,h=n.length|0;t!==h;t++)for(i=n[t],f=t+1;f<h;f++){if(u=n[f],l=u.aabb.lowerBound[c]<=i.aabb.upperBound[c],!l)break;r.canCollide(i,u)&&this.boundingVolumeCheck(i,u)&&e.push(i,u)}return e};i.prototype.aabbQuery=function(n,t,i){var e,r,f,u;i=i||[];this.sortList();e=this.axisIndex;r="x";e===1&&(r="y");e===2&&(r="z");var o=this.axisList,s=t.lowerBound[r],h=t.upperBound[r];for(f=0;f<o.length;f++)u=o[f],u.aabbNeedsUpdate&&u.updateAABB(),u.aabb.overlaps(t)&&i.push(u);return i}},{"../collision/Broadphase":8,"../utils/Utils":50}],15:[function(n,t){function i(n,t,i,u){this.type=i;u=r.defaults(u,{collideConnected:!0,wakeUpBodies:!0});this.equations=[];this.bodyA=n;this.bodyB=t;this.collideConnected=u.collideConnected;u.wakeUpBodies&&(n&&n.wakeUp(),t&&t.wakeUp())}t.exports=i;var r=n("../utils/Utils");i.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!");};i.DISTANCE=1;i.GEAR=2;i.LOCK=3;i.PRISMATIC=4;i.REVOLUTE=5;i.prototype.setStiffness=function(n){for(var i,r=this.equations,t=0;t!==r.length;t++)i=r[t],i.stiffness=n,i.needsUpdate=!0};i.prototype.setRelaxation=function(n){for(var i,r=this.equations,t=0;t!==r.length;t++)i=r[t],i.relaxation=n,i.needsUpdate=!0}},{"../utils/Utils":50}],16:[function(n,t){function u(n,t,r){var o,c,e,l;if(r=h.defaults(r,{localAnchorA:[0,0],localAnchorB:[0,0]}),f.call(this,n,t,f.DISTANCE,r),this.localAnchorA=i.fromValues(r.localAnchorA[0],r.localAnchorA[1]),this.localAnchorB=i.fromValues(r.localAnchorB[0],r.localAnchorB[1]),o=this.localAnchorA,c=this.localAnchorB,this.distance=0,typeof r.distance=="number")this.distance=r.distance;else{var a=i.create(),v=i.create(),u=i.create();i.rotate(a,o,n.angle);i.rotate(v,c,t.angle);i.add(u,t.position,v);i.sub(u,u,a);i.sub(u,u,n.position);this.distance=i.length(u)}e=typeof r.maxForce=="undefined"?Number.MAX_VALUE:r.maxForce;l=new s(n,t,-e,e);this.equations=[l];this.maxForce=e;var u=i.create(),y=i.create(),p=i.create(),w=this;l.computeGq=function(){var n=this.bodyA,t=this.bodyB,r=n.position,f=t.position;return i.rotate(y,o,n.angle),i.rotate(p,c,t.angle),i.add(u,f,p),i.sub(u,u,y),i.sub(u,u,r),i.length(u)-w.distance};this.setMaxForce(e);this.upperLimitEnabled=!1;this.upperLimit=1;this.lowerLimitEnabled=!1;this.lowerLimit=0;this.position=0}var f=n("./Constraint"),s=n("../equations/Equation"),i=n("../math/vec2"),h=n("../utils/Utils");t.exports=u;u.prototype=new f;u.prototype.constructor=u;var r=i.create(),e=i.create(),o=i.create();u.prototype.update=function(){var l=this.equations[0],f=this.bodyA,s=this.bodyB,y=this.distance,a=f.position,v=s.position,n=this.equations[0],t=l.G,u,h,c;if(i.rotate(e,this.localAnchorA,f.angle),i.rotate(o,this.localAnchorB,s.angle),i.add(r,v,o),i.sub(r,r,e),i.sub(r,r,a),this.position=i.length(r),u=!1,this.upperLimitEnabled&&this.position>this.upperLimit&&(n.maxForce=0,n.minForce=-this.maxForce,this.distance=this.upperLimit,u=!0),this.lowerLimitEnabled&&this.position<this.lowerLimit&&(n.maxForce=this.maxForce,n.minForce=0,this.distance=this.lowerLimit,u=!0),(this.lowerLimitEnabled||this.upperLimitEnabled)&&!u){n.enabled=!1;return}n.enabled=!0;i.normalize(r,r);h=i.crossLength(e,r);c=i.crossLength(o,r);t[0]=-r[0];t[1]=-r[1];t[2]=-h;t[3]=r[0];t[4]=r[1];t[5]=c};u.prototype.setMaxForce=function(n){var t=this.equations[0];t.minForce=-n;t.maxForce=n};u.prototype.getMaxForce=function(){var n=this.equations[0];return n.maxForce}},{"../equations/Equation":23,"../math/vec2":31,"../utils/Utils":50,"./Constraint":15}],17:[function(n,t){function i(n,t,i){i=i||{};r.call(this,n,t,r.GEAR,i);this.ratio=typeof i.ratio=="number"?i.ratio:1;this.angle=typeof i.angle=="number"?i.angle:t.angle-this.ratio*n.angle;i.angle=this.angle;i.ratio=this.ratio;this.equations=[new u(n,t,i),];typeof i.maxTorque=="number"&&this.setMaxTorque(i.maxTorque)}var r=n("./Constraint"),f=n("../equations/Equation"),u=n("../equations/AngleLockEquation"),e=n("../math/vec2");t.exports=i;i.prototype=new r;i.prototype.constructor=i;i.prototype.update=function(){var n=this.equations[0];n.ratio!==this.ratio&&n.setRatio(this.ratio);n.angle=this.angle};i.prototype.setMaxTorque=function(n){this.equations[0].setMaxTorque(n)};i.prototype.getMaxTorque=function(){return this.equations[0].maxForce}},{"../equations/AngleLockEquation":21,"../equations/Equation":23,"../math/vec2":31,"./Constraint":15}],18:[function(n,t){function u(n,t,r){var s,h;r=r||{};e.call(this,n,t,e.LOCK,r);var f=typeof r.maxForce=="undefined"?Number.MAX_VALUE:r.maxForce,p=r.localAngleB||0,a=new o(n,t,-f,f),v=new o(n,t,-f,f),y=new o(n,t,-f,f),c=i.create(),u=i.create(),l=this;a.computeGq=function(){return i.rotate(c,l.localOffsetB,n.angle),i.sub(u,t.position,n.position),i.sub(u,u,c),u[0]};v.computeGq=function(){return i.rotate(c,l.localOffsetB,n.angle),i.sub(u,t.position,n.position),i.sub(u,u,c),u[1]};s=i.create();h=i.create();y.computeGq=function(){return i.rotate(s,l.localOffsetB,t.angle-l.localAngleB),i.scale(s,s,-1),i.sub(u,n.position,t.position),i.add(u,u,s),i.rotate(h,s,-Math.PI/2),i.normalize(h,h),i.dot(u,h)};this.localOffsetB=i.create();r.localOffsetB?i.copy(this.localOffsetB,r.localOffsetB):(i.sub(this.localOffsetB,t.position,n.position),i.rotate(this.localOffsetB,this.localOffsetB,-n.angle));this.localAngleB=0;this.localAngleB=typeof r.localAngleB=="number"?r.localAngleB:t.angle-n.angle;this.equations.push(a,v,y);this.setMaxForce(f)}var e=n("./Constraint"),i=n("../math/vec2"),o=n("../equations/Equation");t.exports=u;u.prototype=new e;u.prototype.constructor=u;u.prototype.setMaxForce=function(n){for(var i=this.equations,t=0;t<this.equations.length;t++)i[t].maxForce=n,i[t].minForce=-n};u.prototype.getMaxForce=function(){return this.equations[0].maxForce};var s=i.create(),f=i.create(),r=i.create(),h=i.fromValues(1,0),c=i.fromValues(0,1);u.prototype.update=function(){var t=this.equations[0],u=this.equations[1],n=this.equations[2],e=this.bodyA,o=this.bodyB;i.rotate(s,this.localOffsetB,e.angle);i.rotate(f,this.localOffsetB,o.angle-this.localAngleB);i.scale(f,f,-1);i.rotate(r,f,Math.PI/2);i.normalize(r,r);t.G[0]=-1;t.G[1]=0;t.G[2]=-i.crossLength(s,h);t.G[3]=1;u.G[0]=0;u.G[1]=-1;u.G[2]=-i.crossLength(s,c);u.G[4]=1;n.G[0]=-r[0];n.G[1]=-r[1];n.G[3]=r[0];n.G[4]=r[1];n.G[5]=i.crossLength(f,r)}},{"../equations/Equation":23,"../math/vec2":31,"./Constraint":15}],19:[function(n,t){function u(n,t,r){var k;r=r||{};s.call(this,n,t,s.PRISMATIC,r);var o=i.fromValues(0,0),h=i.fromValues(1,0),c=i.fromValues(0,0);r.localAnchorA&&i.copy(o,r.localAnchorA);r.localAxisA&&i.copy(h,r.localAxisA);r.localAnchorB&&i.copy(c,r.localAnchorB);this.localAnchorA=o;this.localAnchorB=c;this.localAxisA=h;var e=this.maxForce=typeof r.maxForce!="undefined"?r.maxForce:Number.MAX_VALUE,y=new a(n,t,-e,e),p=new i.create,w=new i.create,f=new i.create,u=new i.create;y.computeGq=function(){return i.dot(f,u)};y.updateJacobian=function(){var r=this.G,e=n.position,s=t.position;i.rotate(p,o,n.angle);i.rotate(w,c,t.angle);i.add(f,s,w);i.sub(f,f,e);i.sub(f,f,p);i.rotate(u,h,n.angle+Math.PI/2);r[0]=-u[0];r[1]=-u[1];r[2]=-i.crossLength(p,u)+i.crossLength(u,f);r[3]=u[0];r[4]=u[1];r[5]=i.crossLength(w,u)};this.equations.push(y);r.disableRotationalLock||(k=new v(n,t,-e,e),this.equations.push(k));this.position=0;this.velocity=0;this.lowerLimitEnabled=typeof r.lowerLimit!="undefined"?!0:!1;this.upperLimitEnabled=typeof r.upperLimit!="undefined"?!0:!1;this.lowerLimit=typeof r.lowerLimit!="undefined"?r.lowerLimit:0;this.upperLimit=typeof r.upperLimit!="undefined"?r.upperLimit:1;this.upperLimitEquation=new l(n,t);this.lowerLimitEquation=new l(n,t);this.upperLimitEquation.minForce=this.lowerLimitEquation.minForce=0;this.upperLimitEquation.maxForce=this.lowerLimitEquation.maxForce=e;this.motorEquation=new a(n,t);this.motorEnabled=!1;this.motorSpeed=0;var d=this,b=this.motorEquation,g=b.computeGW;b.computeGq=function(){return 0};b.computeGW=function(){var i=this.G,n=this.bodyA,t=this.bodyB,r=n.velocity,u=t.velocity,f=n.angularVelocity,e=t.angularVelocity;return this.gmult(i,r,f,u,e)+d.motorSpeed}}var s=n("./Constraint"),l=n("../equations/ContactEquation"),a=n("../equations/Equation"),i=n("../math/vec2"),v=n("../equations/RotationalLockEquation");t.exports=u;u.prototype=new s;u.prototype.constructor=u;var r=i.create(),f=i.create(),e=i.create(),h=i.create(),c=i.create(),o=i.create();u.prototype.update=function(){var n=this.equations,b=n[0],p=this.upperLimit,w=this.lowerLimit,t=this.upperLimitEquation,u=this.lowerLimitEquation,a=this.bodyA,v=this.bodyB,k=this.localAxisA,d=this.localAnchorA,g=this.localAnchorB,y,s,l;b.updateJacobian();i.rotate(r,k,a.angle);i.rotate(h,d,a.angle);i.add(f,h,a.position);i.rotate(c,g,v.angle);i.add(e,c,v.position);y=this.position=i.dot(e,r)-i.dot(f,r);this.motorEnabled&&(s=this.motorEquation.G,s[0]=r[0],s[1]=r[1],s[2]=i.crossLength(r,c),s[3]=-r[0],s[4]=-r[1],s[5]=-i.crossLength(r,h));this.upperLimitEnabled&&y>p?(i.scale(t.normalA,r,-1),i.sub(t.contactPointA,f,a.position),i.sub(t.contactPointB,e,v.position),i.scale(o,r,p),i.add(t.contactPointA,t.contactPointA,o),n.indexOf(t)===-1&&n.push(t)):(l=n.indexOf(t),l!==-1&&n.splice(l,1));this.lowerLimitEnabled&&y<w?(i.scale(u.normalA,r,1),i.sub(u.contactPointA,f,a.position),i.sub(u.contactPointB,e,v.position),i.scale(o,r,w),i.sub(u.contactPointB,u.contactPointB,o),n.indexOf(u)===-1&&n.push(u)):(l=n.indexOf(u),l!==-1&&n.splice(l,1))};u.prototype.enableMotor=function(){this.motorEnabled||(this.equations.push(this.motorEquation),this.motorEnabled=!0)};u.prototype.disableMotor=function(){if(this.motorEnabled){var n=this.equations.indexOf(this.motorEquation);this.equations.splice(n,1);this.motorEnabled=!1}};u.prototype.setLimits=function(n,t){typeof n=="number"?(this.lowerLimit=n,this.lowerLimitEnabled=!0):(this.lowerLimit=n,this.lowerLimitEnabled=!1);typeof t=="number"?(this.upperLimit=t,this.upperLimitEnabled=!0):(this.upperLimit=t,this.upperLimitEnabled=!1)}},{"../equations/ContactEquation":22,"../equations/Equation":23,"../equations/RotationalLockEquation":25,"../math/vec2":31,"./Constraint":15}],20:[function(n,t){function u(n,t,u){var v;u=u||{};o.call(this,n,t,o.REVOLUTE,u);v=this.maxForce=typeof u.maxForce!="undefined"?u.maxForce:Number.MAX_VALUE;this.pivotA=i.create();this.pivotB=i.create();u.worldPivot?(i.sub(this.pivotA,u.worldPivot,n.position),i.sub(this.pivotB,u.worldPivot,t.position),i.rotate(this.pivotA,this.pivotA,-n.angle),i.rotate(this.pivotB,this.pivotB,-t.angle)):(i.copy(this.pivotA,u.localPivotA),i.copy(this.pivotB,u.localPivotB));var b=this.equations=[new c(n,t,-v,v),new c(n,t,-v,v),],p=b[0],w=b[1],y=this;p.computeGq=function(){return i.rotate(f,y.pivotA,n.angle),i.rotate(e,y.pivotB,t.angle),i.add(r,t.position,e),i.sub(r,r,n.position),i.sub(r,r,f),i.dot(r,s)};w.computeGq=function(){return i.rotate(f,y.pivotA,n.angle),i.rotate(e,y.pivotB,t.angle),i.add(r,t.position,e),i.sub(r,r,n.position),i.sub(r,r,f),i.dot(r,h)};w.minForce=p.minForce=-v;w.maxForce=p.maxForce=v;this.motorEquation=new a(n,t);this.motorEnabled=!1;this.angle=0;this.lowerLimitEnabled=!1;this.upperLimitEnabled=!1;this.lowerLimit=0;this.upperLimit=0;this.upperLimitEquation=new l(n,t);this.lowerLimitEquation=new l(n,t);this.upperLimitEquation.minForce=0;this.lowerLimitEquation.maxForce=0}var o=n("./Constraint"),c=n("../equations/Equation"),a=n("../equations/RotationalVelocityEquation"),l=n("../equations/RotationalLockEquation"),i=n("../math/vec2");t.exports=u;var f=i.create(),e=i.create(),s=i.fromValues(1,0),h=i.fromValues(0,1),r=i.create();u.prototype=new o;u.prototype.constructor=u;u.prototype.setLimits=function(n,t){typeof n=="number"?(this.lowerLimit=n,this.lowerLimitEnabled=!0):(this.lowerLimit=n,this.lowerLimitEnabled=!1);typeof t=="number"?(this.upperLimit=t,this.upperLimitEnabled=!0):(this.upperLimit=t,this.upperLimitEnabled=!1)};u.prototype.update=function(){var l=this.bodyA,a=this.bodyB,w=this.pivotA,b=this.pivotB,n=this.equations,k=n[0],d=n[1],t=n[0],r=n[1],v=this.upperLimit,y=this.lowerLimit,o=this.upperLimitEquation,c=this.lowerLimitEquation,p=this.angle=a.angle-l.angle,u;this.upperLimitEnabled&&p>v?(o.angle=v,n.indexOf(o)===-1&&n.push(o)):(u=n.indexOf(o),u!==-1&&n.splice(u,1));this.lowerLimitEnabled&&p<y?(c.angle=y,n.indexOf(c)===-1&&n.push(c)):(u=n.indexOf(c),u!==-1&&n.splice(u,1));i.rotate(f,w,l.angle);i.rotate(e,b,a.angle);t.G[0]=-1;t.G[1]=0;t.G[2]=-i.crossLength(f,s);t.G[3]=1;t.G[4]=0;t.G[5]=i.crossLength(e,s);r.G[0]=0;r.G[1]=-1;r.G[2]=-i.crossLength(f,h);r.G[3]=0;r.G[4]=1;r.G[5]=i.crossLength(e,h)};u.prototype.enableMotor=function(){this.motorEnabled||(this.equations.push(this.motorEquation),this.motorEnabled=!0)};u.prototype.disableMotor=function(){if(this.motorEnabled){var n=this.equations.indexOf(this.motorEquation);this.equations.splice(n,1);this.motorEnabled=!1}};u.prototype.motorIsEnabled=function(){return!!this.motorEnabled};u.prototype.setMotorSpeed=function(n){if(this.motorEnabled){var t=this.equations.indexOf(this.motorEquation);this.equations[t].relativeVelocity=n}};u.prototype.getMotorSpeed=function(){return this.motorEnabled?this.motorEquation.relativeVelocity:!1}},{"../equations/Equation":23,"../equations/RotationalLockEquation":25,"../equations/RotationalVelocityEquation":26,"../math/vec2":31,"./Constraint":15}],21:[function(n,t){function i(n,t,i){i=i||{};r.call(this,n,t,-Number.MAX_VALUE,Number.MAX_VALUE);this.angle=i.angle||0;this.ratio=typeof i.ratio=="number"?i.ratio:1;this.setRatio(this.ratio)}var r=n("./Equation"),u=n("../math/vec2");t.exports=i;i.prototype=new r;i.prototype.constructor=i;i.prototype.computeGq=function(){return this.ratio*this.bodyA.angle-this.bodyB.angle+this.angle};i.prototype.setRatio=function(n){var t=this.G;t[2]=n;t[5]=-1;this.ratio=n};i.prototype.setMaxTorque=function(n){this.maxForce=n;this.minForce=-n}},{"../math/vec2":31,"./Equation":23}],22:[function(n,t){function r(n,t){u.call(this,n,t,0,Number.MAX_VALUE);this.contactPointA=i.create();this.penetrationVec=i.create();this.contactPointB=i.create();this.normalA=i.create();this.restitution=0;this.firstImpact=!1;this.shapeA=null;this.shapeB=null}var u=n("./Equation"),i=n("../math/vec2");t.exports=r;r.prototype=new u;r.prototype.constructor=r;r.prototype.computeB=function(n,t,r){var v=this.bodyA,y=this.bodyB,h=this.contactPointA,c=this.contactPointB,p=v.position,w=y.position,f=this.penetrationVec,u=this.normalA,e=this.G,b=i.crossLength(h,u),k=i.crossLength(c,u),o,s,l,a;return e[0]=-u[0],e[1]=-u[1],e[2]=-b,e[3]=u[0],e[4]=u[1],e[5]=k,i.add(f,w,c),i.sub(f,f,p),i.sub(f,f,h),this.firstImpact&&this.restitution!==0?(s=0,o=1/t*(1+this.restitution)*this.computeGW()):(s=i.dot(u,f)+this.offset,o=this.computeGW()),l=this.computeGiMf(),a=-s*n-o*t-r*l,a}},{"../math/vec2":31,"./Equation":23}],23:[function(n,t){function i(n,t,r,u){this.minForce=typeof r=="undefined"?-Number.MAX_VALUE:r;this.maxForce=typeof u=="undefined"?Number.MAX_VALUE:u;this.bodyA=n;this.bodyB=t;this.stiffness=i.DEFAULT_STIFFNESS;this.relaxation=i.DEFAULT_RELAXATION;this.G=new s.ARRAY_TYPE(6);for(var f=0;f<6;f++)this.G[f]=0;this.offset=0;this.a=0;this.b=0;this.epsilon=0;this.timeStep=1/60;this.needsUpdate=!0;this.multiplier=0;this.relativeVelocity=0;this.enabled=!0}var e,o,u,f;t.exports=i;var r=n("../math/vec2"),s=n("../utils/Utils"),p=n("../objects/Body");i.prototype.constructor=i;i.DEFAULT_STIFFNESS=1e6;i.DEFAULT_RELAXATION=4;i.prototype.update=function(){var i=this.stiffness,n=this.relaxation,t=this.timeStep;this.a=4/(t*(1+4*n));this.b=4*n/(1+4*n);this.epsilon=4/(t*t*i*(1+4*n));this.needsUpdate=!1};i.prototype.gmult=function(n,t,i,r,u){return n[0]*t[0]+n[1]*t[1]+n[2]*i+n[3]*r[0]+n[4]*r[1]+n[5]*u};i.prototype.computeB=function(n,t,i){var r=this.computeGW(),u=this.computeGq(),f=this.computeGiMf();return-u*n-r*t-f*i};e=r.create();o=r.create();i.prototype.computeGq=function(){var i=this.G,n=this.bodyA,t=this.bodyB,f=n.position,s=t.position,r=n.angle,u=t.angle;return this.gmult(i,e,r,o,u)+this.offset};i.prototype.computeGW=function(){var i=this.G,n=this.bodyA,t=this.bodyB,r=n.velocity,u=t.velocity,f=n.angularVelocity,e=t.angularVelocity;return this.gmult(i,r,f,u,e)+this.relativeVelocity};i.prototype.computeGWlambda=function(){var i=this.G,n=this.bodyA,t=this.bodyB,r=n.vlambda,u=t.vlambda,f=n.wlambda,e=t.wlambda;return this.gmult(i,r,f,u,e)};u=r.create();f=r.create();i.prototype.computeGiMf=function(){var n=this.bodyA,t=this.bodyB,i=n.force,e=n.angularForce,o=t.force,s=t.angularForce,h=n.invMassSolve,c=t.invMassSolve,l=n.invInertiaSolve,a=t.invInertiaSolve,v=this.G;return r.scale(u,i,h),r.scale(f,o,c),this.gmult(v,u,e*l,f,s*a)};i.prototype.computeGiMGt=function(){var t=this.bodyA,i=this.bodyB,r=t.invMassSolve,u=i.invMassSolve,f=t.invInertiaSolve,e=i.invInertiaSolve,n=this.G;return n[0]*n[0]*r+n[1]*n[1]*r+n[2]*n[2]*f+n[3]*n[3]*u+n[4]*n[4]*u+n[5]*n[5]*e};var h=r.create(),c=r.create(),l=r.create(),a=r.create(),v=r.create(),y=r.create();i.prototype.addToWlambda=function(n){var i=this.bodyA,u=this.bodyB,f=h,e=c,o=l,k=a,d=v,s=i.invMassSolve,p=u.invMassSolve,w=i.invInertiaSolve,b=u.invInertiaSolve,g=y,t=this.G;e[0]=t[0];e[1]=t[1];o[0]=t[3];o[1]=t[4];r.scale(f,e,s*n);r.add(i.vlambda,i.vlambda,f);i.wlambda+=w*t[2]*n;r.scale(f,o,p*n);r.add(u.vlambda,u.vlambda,f);u.wlambda+=b*t[5]*n};i.prototype.computeInvC=function(n){return 1/(this.computeGiMGt()+n)}},{"../math/vec2":31,"../objects/Body":32,"../utils/Utils":50}],24:[function(n,t){function i(n,t,i){u.call(this,n,t,-i,i);this.contactPointA=r.create();this.contactPointB=r.create();this.t=r.create();this.contactEquations=[];this.shapeA=null;this.shapeB=null;this.frictionCoefficient=.3}var r=n("../math/vec2"),u=n("./Equation"),f=n("../utils/Utils");t.exports=i;i.prototype=new u;i.prototype.constructor=i;i.prototype.setSlipForce=function(n){this.maxForce=n;this.minForce=-n};i.prototype.getSlipForce=function(){return this.maxForce};i.prototype.computeB=function(n,t,i){var c=this.bodyA,l=this.bodyB,e=this.contactPointA,o=this.contactPointB,u=this.t,f=this.G;f[0]=-u[0];f[1]=-u[1];f[2]=-r.crossLength(e,u);f[3]=u[0];f[4]=u[1];f[5]=r.crossLength(o,u);var s=this.computeGW(),h=this.computeGiMf();return-s*t-i*h}},{"../math/vec2":31,"../utils/Utils":50,"./Equation":23}],25:[function(n,t){function r(n,t,i){i=i||{};u.call(this,n,t,-Number.MAX_VALUE,Number.MAX_VALUE);this.angle=i.angle||0;var r=this.G;r[2]=1;r[5]=-1}var u=n("./Equation"),i=n("../math/vec2");t.exports=r;r.prototype=new u;r.prototype.constructor=r;var f=i.create(),e=i.create(),o=i.fromValues(1,0),s=i.fromValues(0,1);r.prototype.computeGq=function(){return i.rotate(f,o,this.bodyA.angle+this.angle),i.rotate(e,s,this.bodyB.angle),i.dot(f,e)}},{"../math/vec2":31,"./Equation":23}],26:[function(n,t){function i(n,t){r.call(this,n,t,-Number.MAX_VALUE,Number.MAX_VALUE);this.relativeVelocity=1;this.ratio=1}var r=n("./Equation"),u=n("../math/vec2");t.exports=i;i.prototype=new r;i.prototype.constructor=i;i.prototype.computeB=function(n,t,i){var r=this.G;r[2]=-1;r[5]=this.ratio;var u=this.computeGiMf(),f=this.computeGW();return-f*t-i*u}},{"../math/vec2":31,"./Equation":23}],27:[function(n,t){var i=function(){};t.exports=i;i.prototype={constructor:i,on:function(n,t,i){t.context=i||this;this._listeners===undefined&&(this._listeners={});var r=this._listeners;return r[n]===undefined&&(r[n]=[]),r[n].indexOf(t)===-1&&r[n].push(t),this},has:function(n,t){if(this._listeners===undefined)return!1;var i=this._listeners;if(t){if(i[n]!==undefined&&i[n].indexOf(t)!==-1)return!0}else if(i[n]!==undefined)return!0;return!1},off:function(n,t){if(this._listeners===undefined)return this;var i=this._listeners,r=i[n].indexOf(t);return r!==-1&&i[n].splice(r,1),this},emit:function(n){var u,t,i,f,r;if(this._listeners===undefined)return this;if(u=this._listeners,t=u[n.type],t!==undefined)for(n.target=this,i=0,f=t.length;i<f;i++)r=t[i],r.call(r.context,n);return this}}},{}],28:[function(n,t){function r(n,t,f){if(f=f||{},!(n instanceof u)||!(t instanceof u))throw new Error("First two arguments must be Material instances.");this.id=r.idCounter++;this.materialA=n;this.materialB=t;this.friction=typeof f.friction!="undefined"?Number(f.friction):.3;this.restitution=typeof f.restitution!="undefined"?Number(f.restitution):0;this.stiffness=typeof f.stiffness!="undefined"?Number(f.stiffness):i.DEFAULT_STIFFNESS;this.relaxation=typeof f.relaxation!="undefined"?Number(f.relaxation):i.DEFAULT_RELAXATION;this.frictionStiffness=typeof f.frictionStiffness!="undefined"?Number(f.frictionStiffness):i.DEFAULT_STIFFNESS;this.frictionRelaxation=typeof f.frictionRelaxation!="undefined"?Number(f.frictionRelaxation):i.DEFAULT_RELAXATION;this.surfaceVelocity=typeof f.surfaceVelocity!="undefined"?Number(f.surfaceVelocity):0;this.contactSkinSize=.005}var u=n("./Material"),i=n("../equations/Equation");t.exports=r;r.idCounter=0},{"../equations/Equation":23,"./Material":29}],29:[function(n,t){function i(n){this.id=n||i.idCounter++}t.exports=i;i.idCounter=0},{}],30:[function(n,t){var i={};i.GetArea=function(n){var i,r,t;if(n.length<6)return 0;for(i=n.length-2,r=0,t=0;t<i;t+=2)r+=(n[t+2]-n[t])*(n[t+1]+n[t+3]);return r+=(n[0]-n[i])*(n[i+1]+n[1]),-r*.5};i.Triangulate=function(n){var l=n.length>>1,e,r,t,u,c,f;if(l<3)return[];for(e=[],r=[],t=0;t<l;t++)r.push(t);for(t=0,u=l;u>3;){var o=r[(t+0)%u],s=r[(t+1)%u],h=r[(t+2)%u],v=n[2*o],y=n[2*o+1],p=n[2*s],w=n[2*s+1],b=n[2*h],k=n[2*h+1],a=!1;if(i._convex(v,y,p,w,b,k))for(a=!0,c=0;c<u;c++)if((f=r[c],f!=o&&f!=s&&f!=h)&&i._PointInTriangle(n[2*f],n[2*f+1],v,y,p,w,b,k)){a=!1;break}if(a)e.push(o,s,h),r.splice((t+1)%u,1),u--,t=0;else if(t++>3*u)break}return e.push(r[0],r[1],r[2]),e};i._PointInTriangle=function(n,t,i,r,u,f,e,o){var s=e-i,h=o-r,c=u-i,l=f-r,v=n-i,y=t-r,p=s*s+h*h,a=s*c+h*l,w=s*v+h*y,b=c*c+l*l,k=c*v+l*y,d=1/(p*b-a*a),g=(b*w-a*k)*d,nt=(p*k-a*w)*d;return g>=0&&nt>=0&&g+nt<1};i._convex=function(n,t,i,r,u,f){return(t-r)*(u-i)+(i-n)*(f-r)>=0};t.exports=i},{}],31:[function(n,t){var i=t.exports={},r=n("../utils/Utils");i.crossLength=function(n,t){return n[0]*t[1]-n[1]*t[0]};i.crossVZ=function(n,t,r){return i.rotate(n,t,-Math.PI/2),i.scale(n,n,r),n};i.crossZV=function(n,t,r){return i.rotate(n,r,Math.PI/2),i.scale(n,n,t),n};i.rotate=function(n,t,i){if(i!==0){var r=Math.cos(i),u=Math.sin(i),f=t[0],e=t[1];n[0]=r*f-u*e;n[1]=u*f+r*e}else n[0]=t[0],n[1]=t[1]};i.rotate90cw=function(n,t){var i=t[0],r=t[1];n[0]=r;n[1]=-i};i.toLocalFrame=function(n,t,r,u){i.copy(n,t);i.sub(n,n,r);i.rotate(n,n,-u)};i.toGlobalFrame=function(n,t,r,u){i.copy(n,t);i.rotate(n,n,u);i.add(n,n,r)};i.centroid=function(n,t,r,u){return i.add(n,t,r),i.add(n,n,u),i.scale(n,n,1/3),n};i.create=function(){var n=new r.ARRAY_TYPE(2);return n[0]=0,n[1]=0,n};i.clone=function(n){var t=new r.ARRAY_TYPE(2);return t[0]=n[0],t[1]=n[1],t};i.fromValues=function(n,t){var i=new r.ARRAY_TYPE(2);return i[0]=n,i[1]=t,i};i.copy=function(n,t){return n[0]=t[0],n[1]=t[1],n};i.set=function(n,t,i){return n[0]=t,n[1]=i,n};i.add=function(n,t,i){return n[0]=t[0]+i[0],n[1]=t[1]+i[1],n};i.subtract=function(n,t,i){return n[0]=t[0]-i[0],n[1]=t[1]-i[1],n};i.sub=i.subtract;i.multiply=function(n,t,i){return n[0]=t[0]*i[0],n[1]=t[1]*i[1],n};i.mul=i.multiply;i.divide=function(n,t,i){return n[0]=t[0]/i[0],n[1]=t[1]/i[1],n};i.div=i.divide;i.scale=function(n,t,i){return n[0]=t[0]*i,n[1]=t[1]*i,n};i.distance=function(n,t){var i=t[0]-n[0],r=t[1]-n[1];return Math.sqrt(i*i+r*r)};i.dist=i.distance;i.squaredDistance=function(n,t){var i=t[0]-n[0],r=t[1]-n[1];return i*i+r*r};i.sqrDist=i.squaredDistance;i.length=function(n){var t=n[0],i=n[1];return Math.sqrt(t*t+i*i)};i.len=i.length;i.squaredLength=function(n){var t=n[0],i=n[1];return t*t+i*i};i.sqrLen=i.squaredLength;i.negate=function(n,t){return n[0]=-t[0],n[1]=-t[1],n};i.normalize=function(n,t){var r=t[0],u=t[1],i=r*r+u*u;return i>0&&(i=1/Math.sqrt(i),n[0]=t[0]*i,n[1]=t[1]*i),n};i.dot=function(n,t){return n[0]*t[0]+n[1]*t[1]};i.str=function(n){return"vec2("+n[0]+", "+n[1]+")"};i.lerp=function(n,t,i,r){var u=t[0],f=t[1];return n[0]=u+r*(i[0]-u),n[1]=f+r*(i[1]-f),n}},{"../utils/Utils":50}],32:[function(n,t){function r(n){n=n||{};l.call(this);this.id=++r._idCounter;this.world=null;this.shapes=[];this.shapeOffsets=[];this.shapeAngles=[];this.mass=n.mass||0;this.invMass=0;this.inertia=0;this.invInertia=0;this.invMassSolve=0;this.invInertiaSolve=0;this.fixedRotation=!!n.fixedRotation;this.position=i.fromValues(0,0);n.position&&i.copy(this.position,n.position);this.interpolatedPosition=i.fromValues(0,0);this.interpolatedAngle=0;this.previousPosition=i.fromValues(0,0);this.previousAngle=0;this.velocity=i.fromValues(0,0);n.velocity&&i.copy(this.velocity,n.velocity);this.vlambda=i.fromValues(0,0);this.wlambda=0;this.angle=n.angle||0;this.angularVelocity=n.angularVelocity||0;this.force=i.create();n.force&&i.copy(this.force,n.force);this.angularForce=n.angularForce||0;this.damping=typeof n.damping=="number"?n.damping:.1;this.angularDamping=typeof n.angularDamping=="number"?n.angularDamping:.1;this.type=r.STATIC;this.type=typeof n.type!="undefined"?n.type:n.mass?r.DYNAMIC:r.STATIC;this.boundingRadius=0;this.aabb=new c;this.aabbNeedsUpdate=!0;this.allowSleep=!0;this.wantsToSleep=!1;this.sleepState=r.AWAKE;this.sleepSpeedLimit=.2;this.sleepTimeLimit=1;this.gravityScale=1;this.collisionResponse=!0;this.idleTime=0;this.timeLastSleepy=0;this.ccdSpeedThreshold=n.ccdSpeedThreshold!==undefined?n.ccdSpeedThreshold:-1;this.ccdIterations=n.ccdIterations!==undefined?n.ccdIterations:10;this.concavePath=null;this._wakeUpAfterNarrowphase=!1;this.updateMassProperties()}var i=n("../math/vec2"),y=n("poly-decomp"),p=n("../shapes/Convex"),c=n("../collision/AABB"),l=n("../events/EventEmitter"),o,a,v,s,u;t.exports=r;r.prototype=new l;r.prototype.constructor=r;r._idCounter=0;r.prototype.updateSolveMassProperties=function(){this.sleepState===r.SLEEPING||this.type===r.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve=0):(this.invMassSolve=this.invMass,this.invInertiaSolve=this.invInertia)};r.prototype.setDensity=function(n){var t=this.getArea();this.mass=t*n;this.updateMassProperties()};r.prototype.getArea=function(){for(var t=0,n=0;n<this.shapes.length;n++)t+=this.shapes[n].area;return t};r.prototype.getAABB=function(){return this.aabbNeedsUpdate&&this.updateAABB(),this.aabb};o=new c;a=i.create();r.prototype.updateAABB=function(){for(var f,e,r=this.shapes,s=this.shapeOffsets,h=this.shapeAngles,c=r.length,t=a,u=this.angle,n=0;n!==c;n++)f=r[n],e=h[n]+u,i.rotate(t,s[n],u),i.add(t,t,this.position),f.computeAABB(o,t,e),n===0?this.aabb.copy(o):this.aabb.extend(o);this.aabbNeedsUpdate=!1};r.prototype.updateBoundingRadius=function(){for(var r=this.shapes,e=this.shapeOffsets,o=r.length,t=0,n=0;n!==o;n++){var s=r[n],u=i.length(e[n]),f=s.boundingRadius;u+f>t&&(t=u+f)}this.boundingRadius=t};r.prototype.addShape=function(n,t,r){r=r||0;t=t?i.fromValues(t[0],t[1]):i.fromValues(0,0);this.shapes.push(n);this.shapeOffsets.push(t);this.shapeAngles.push(r);this.updateMassProperties();this.updateBoundingRadius();this.aabbNeedsUpdate=!0};r.prototype.removeShape=function(n){var t=this.shapes.indexOf(n);return t!==-1?(this.shapes.splice(t,1),this.shapeOffsets.splice(t,1),this.shapeAngles.splice(t,1),this.aabbNeedsUpdate=!0,!0):!1};r.prototype.updateMassProperties=function(){var n;if(this.type===r.STATIC||this.type===r.KINEMATIC)this.mass=Number.MAX_VALUE,this.invMass=0,this.inertia=Number.MAX_VALUE,this.invInertia=0;else{var u=this.shapes,f=u.length,e=this.mass/f,t=0;if(this.fixedRotation)this.inertia=Number.MAX_VALUE,this.invInertia=0;else{for(n=0;n<f;n++){var o=u[n],s=i.squaredLength(this.shapeOffsets[n]),h=o.computeMomentOfInertia(e);t+=h+e*s}this.inertia=t;this.invInertia=t>0?1/t:0}this.invMass=1/this.mass}};v=i.create();r.prototype.applyForce=function(n,t){var r=v,u;i.sub(r,t,this.position);i.add(this.force,this.force,n);u=i.crossLength(r,n);this.angularForce+=u};r.prototype.toLocalFrame=function(n,t){i.toLocalFrame(n,t,this.position,this.angle)};r.prototype.toWorldFrame=function(n,t){i.toGlobalFrame(n,t,this.position,this.angle)};r.prototype.fromPolygon=function(n,t){var f,s,h,r,u,o,e;for(t=t||{},r=this.shapes.length;r>=0;--r)this.removeShape(this.shapes[r]);if(f=new y.Polygon,f.vertices=n,f.makeCCW(),typeof t.removeCollinearPoints=="number"&&f.removeCollinearPoints(t.removeCollinearPoints),typeof t.skipSimpleCheck=="undefined"&&!f.isSimple())return!1;for(this.concavePath=f.vertices.slice(0),r=0;r<this.concavePath.length;r++)e=[0,0],i.copy(e,this.concavePath[r]),this.concavePath[r]=e;for(s=t.optimalDecomp?f.decomp():f.quickDecomp(),h=i.create(),r=0;r!==s.length;r++){for(u=new p(s[r].vertices),o=0;o!==u.vertices.length;o++)e=u.vertices[o],i.sub(e,e,u.centerOfMass);i.scale(h,u.centerOfMass,1);u.updateTriangles();u.updateCenterOfMass();u.updateBoundingRadius();this.addShape(u,h)}return this.adjustCenterOfMass(),this.aabbNeedsUpdate=!0,!0};var g=i.fromValues(0,0),w=i.fromValues(0,0),b=i.fromValues(0,0),k=i.fromValues(0,0);r.prototype.adjustCenterOfMass=function(){var e=w,r=b,u=k,o=0,f,t,n;for(i.set(r,0,0),n=0;n!==this.shapes.length;n++)f=this.shapes[n],t=this.shapeOffsets[n],i.scale(e,t,f.area),i.add(r,r,e),o+=f.area;for(i.scale(u,r,1/o),n=0;n!==this.shapes.length;n++)f=this.shapes[n],t=this.shapeOffsets[n],t||(t=this.shapeOffsets[n]=i.create()),i.sub(t,t,u);for(i.add(this.position,this.position,u),n=0;this.concavePath&&n<this.concavePath.length;n++)i.sub(this.concavePath[n],this.concavePath[n],u);this.updateMassProperties();this.updateBoundingRadius()};r.prototype.setZeroForce=function(){i.set(this.force,0,0);this.angularForce=0};r.prototype.resetConstraintVelocity=function(){var n=this,t=n.vlambda;i.set(t,0,0);n.wlambda=0};r.prototype.addConstraintVelocity=function(){var n=this,t=n.velocity;i.add(t,t,n.vlambda);n.angularVelocity+=n.wlambda};r.prototype.applyDamping=function(n){if(this.type===r.DYNAMIC){var t=this.velocity;i.scale(t,t,Math.pow(1-this.damping,n));this.angularVelocity*=Math.pow(1-this.angularDamping,n)}};r.prototype.wakeUp=function(){var n=this.sleepState;this.sleepState=r.AWAKE;this.idleTime=0;n!==r.AWAKE&&this.emit(r.wakeUpEvent)};r.prototype.sleep=function(){this.sleepState=r.SLEEPING;this.angularVelocity=0;this.angularForce=0;i.set(this.velocity,0,0);i.set(this.force,0,0);this.emit(r.sleepEvent)};r.prototype.sleepTick=function(n,t,u){if(this.allowSleep&&this.type!==r.SLEEPING){this.wantsToSleep=!1;var o=this.sleepState,f=i.squaredLength(this.velocity)+Math.pow(this.angularVelocity,2),e=Math.pow(this.sleepSpeedLimit,2);f>=e?(this.idleTime=0,this.sleepState=r.AWAKE):(this.idleTime+=u,this.sleepState=r.SLEEPY);this.idleTime>this.sleepTimeLimit&&(t?this.wantsToSleep=!0:this.sleep())}};r.prototype.getVelocityFromPosition=function(n,t){return n=n||i.create(),i.sub(n,this.position,this.previousPosition),i.scale(n,n,1/t),n};r.prototype.getAngularVelocityFromPosition=function(n){return(this.angle-this.previousAngle)/n};r.prototype.overlaps=function(n){return this.world.overlapKeeper.bodiesAreOverlapping(this,n)};s=i.create();u=i.create();r.prototype.integrate=function(n){var f=this.invMass,e=this.force,r=this.position,t=this.velocity;i.copy(this.previousPosition,this.position);this.previousAngle=this.angle;this.fixedRotation||(this.angularVelocity+=this.angularForce*this.invInertia*n);i.scale(s,e,n*f);i.add(t,s,t);this.integrateToTimeOfImpact(n)||(i.scale(u,t,n),i.add(r,r,u),this.fixedRotation||(this.angle+=this.angularVelocity*n));this.aabbNeedsUpdate=!0};var d=i.create(),f=i.create(),e=i.create(),h=i.create();r.prototype.integrateToTimeOfImpact=function(n){var s,p;if(this.ccdSpeedThreshold<0||i.squaredLength(this.velocity)<Math.pow(this.ccdSpeedThreshold,2))return!1;i.normalize(d,this.velocity);i.scale(f,this.velocity,n);i.add(f,f,this.position);i.sub(e,f,this.position);var a=this.angularVelocity*n,w=i.length(e),t=1,r,v=this;if(this.world.raycastAll(this.position,f,{},function(n){n.body!==v&&(r=n.body,i.copy(f,n.hitPointWorld),i.sub(e,n.hitPointWorld,v.position),t=i.length(e)/w,n.abort())}),!r)return!1;s=this.angle;i.copy(h,this.position);for(var y=0,c=0,o=0,l=t;l>=c&&y<this.ccdIterations;)y++,o=(l-c)/2,i.scale(u,e,t),i.add(this.position,h,u),this.angle=s+a*t,this.updateAABB(),p=this.aabb.overlaps(r.aabb)&&this.world.narrowphase.bodiesOverlap(this,r),p?c=o:l=o;return t=o,i.copy(this.position,h),this.angle=s,i.scale(u,e,t),i.add(this.position,this.position,u),this.fixedRotation||(this.angle+=a*t),!0};r.sleepyEvent={type:"sleepy"};r.sleepEvent={type:"sleep"};r.wakeUpEvent={type:"wakeup"};r.DYNAMIC=1;r.STATIC=2;r.KINEMATIC=4;r.AWAKE=0;r.SLEEPY=1;r.SLEEPING=2},{"../collision/AABB":7,"../events/EventEmitter":27,"../math/vec2":31,"../shapes/Convex":39,"poly-decomp":5}],33:[function(n,t){function r(n,t,r){var f,e,o;r=r||{};u.call(this,n,t,r);this.localAnchorA=i.fromValues(0,0);this.localAnchorB=i.fromValues(0,0);r.localAnchorA&&i.copy(this.localAnchorA,r.localAnchorA);r.localAnchorB&&i.copy(this.localAnchorB,r.localAnchorB);r.worldAnchorA&&this.setWorldAnchorA(r.worldAnchorA);r.worldAnchorB&&this.setWorldAnchorB(r.worldAnchorB);f=i.create();e=i.create();this.getWorldAnchorA(f);this.getWorldAnchorB(e);o=i.distance(f,e);this.restLength=typeof r.restLength=="number"?r.restLength:o}var i=n("../math/vec2"),u=n("./Spring"),y=n("../utils/Utils");t.exports=r;r.prototype=new u;r.prototype.constructor=r;r.prototype.setWorldAnchorA=function(n){this.bodyA.toLocalFrame(this.localAnchorA,n)};r.prototype.setWorldAnchorB=function(n){this.bodyB.toLocalFrame(this.localAnchorB,n)};r.prototype.getWorldAnchorA=function(n){this.bodyA.toWorldFrame(n,this.localAnchorA)};r.prototype.getWorldAnchorB=function(n){this.bodyB.toWorldFrame(n,this.localAnchorB)};var f=i.create(),e=i.create(),o=i.create(),s=i.create(),h=i.create(),c=i.create(),l=i.create(),a=i.create(),v=i.create();r.prototype.applyForce=function(){var rt=this.stiffness,ut=this.damping,ft=this.restLength,n=this.bodyA,t=this.bodyB,p=f,w=e,r=o,u=s,y=v,b=h,k=c,d=l,g=a,nt,tt,it;this.getWorldAnchorA(b);this.getWorldAnchorB(k);i.sub(d,b,n.position);i.sub(g,k,t.position);i.sub(p,k,b);nt=i.len(p);i.normalize(w,p);i.sub(r,t.velocity,n.velocity);i.crossZV(y,t.angularVelocity,g);i.add(r,r,y);i.crossZV(y,n.angularVelocity,d);i.sub(r,r,y);i.scale(u,w,-rt*(nt-ft)-ut*i.dot(r,w));i.sub(n.force,n.force,u);i.add(t.force,t.force,u);tt=i.crossLength(d,u);it=i.crossLength(g,u);n.angularForce-=tt;t.angularForce+=it}},{"../math/vec2":31,"../utils/Utils":50,"./Spring":35}],34:[function(n,t){function i(n,t,i){i=i||{};r.call(this,n,t,i);this.restAngle=typeof i.restAngle=="number"?i.restAngle:t.angle-n.angle}var u=n("../math/vec2"),r=n("./Spring");t.exports=i;i.prototype=new r;i.prototype.constructor=i;i.prototype.applyForce=function(){var r=this.stiffness,u=this.damping,f=this.restAngle,n=this.bodyA,t=this.bodyB,e=t.angle-n.angle,o=t.angularVelocity-n.angularVelocity,i=-r*(e-f)-u*o*0;n.angularForce-=i;t.angularForce+=i}},{"../math/vec2":31,"./Spring":35}],35:[function(n,t){function i(n,t,i){i=r.defaults(i,{stiffness:100,damping:1});this.stiffness=i.stiffness;this.damping=i.damping;this.bodyA=n;this.bodyB=t}var u=n("../math/vec2"),r=n("../utils/Utils");t.exports=i;i.prototype.applyForce=function(){}},{"../math/vec2":31,"../utils/Utils":50}],36:[function(n,t){t.exports={AABB:n("./collision/AABB"),AngleLockEquation:n("./equations/AngleLockEquation"),Body:n("./objects/Body"),Broadphase:n("./collision/Broadphase"),Capsule:n("./shapes/Capsule"),Circle:n("./shapes/Circle"),Constraint:n("./constraints/Constraint"),ContactEquation:n("./equations/ContactEquation"),ContactMaterial:n("./material/ContactMaterial"),Convex:n("./shapes/Convex"),DistanceConstraint:n("./constraints/DistanceConstraint"),Equation:n("./equations/Equation"),EventEmitter:n("./events/EventEmitter"),FrictionEquation:n("./equations/FrictionEquation"),GearConstraint:n("./constraints/GearConstraint"),GridBroadphase:n("./collision/GridBroadphase"),GSSolver:n("./solver/GSSolver"),Heightfield:n("./shapes/Heightfield"),Line:n("./shapes/Line"),LockConstraint:n("./constraints/LockConstraint"),Material:n("./material/Material"),Narrowphase:n("./collision/Narrowphase"),NaiveBroadphase:n("./collision/NaiveBroadphase"),Particle:n("./shapes/Particle"),Plane:n("./shapes/Plane"),RevoluteConstraint:n("./constraints/RevoluteConstraint"),PrismaticConstraint:n("./constraints/PrismaticConstraint"),Ray:n("./collision/Ray"),RaycastResult:n("./collision/RaycastResult"),Rectangle:n("./shapes/Rectangle"),RotationalVelocityEquation:n("./equations/RotationalVelocityEquation"),SAPBroadphase:n("./collision/SAPBroadphase"),Shape:n("./shapes/Shape"),Solver:n("./solver/Solver"),Spring:n("./objects/Spring"),LinearSpring:n("./objects/LinearSpring"),RotationalSpring:n("./objects/RotationalSpring"),Utils:n("./utils/Utils"),World:n("./world/World"),vec2:n("./math/vec2"),version:n("../package.json").version}},{"../package.json":6,"./collision/AABB":7,"./collision/Broadphase":8,"./collision/GridBroadphase":9,"./collision/NaiveBroadphase":10,"./collision/Narrowphase":11,"./collision/Ray":12,"./collision/RaycastResult":13,"./collision/SAPBroadphase":14,"./constraints/Constraint":15,"./constraints/DistanceConstraint":16,"./constraints/GearConstraint":17,"./constraints/LockConstraint":18,"./constraints/PrismaticConstraint":19,"./constraints/RevoluteConstraint":20,"./equations/AngleLockEquation":21,"./equations/ContactEquation":22,"./equations/Equation":23,"./equations/FrictionEquation":24,"./equations/RotationalVelocityEquation":26,"./events/EventEmitter":27,"./material/ContactMaterial":28,"./material/Material":29,"./math/vec2":31,"./objects/Body":32,"./objects/LinearSpring":33,"./objects/RotationalSpring":34,"./objects/Spring":35,"./shapes/Capsule":37,"./shapes/Circle":38,"./shapes/Convex":39,"./shapes/Heightfield":40,"./shapes/Line":41,"./shapes/Particle":42,"./shapes/Plane":43,"./shapes/Rectangle":44,"./shapes/Shape":45,"./solver/GSSolver":46,"./solver/Solver":47,"./utils/Utils":50,"./world/World":54}],37:[function(n,t){function r(n,t){this.length=n||1;this.radius=t||1;f.call(this,f.CAPSULE)}var f=n("./Shape"),u=n("../math/vec2"),i;t.exports=r;r.prototype=new f;r.prototype.constructor=r;r.prototype.computeMomentOfInertia=function(n){var t=this.radius,i=this.length+t,r=t*2;return n*(r*r+i*i)/12};r.prototype.updateBoundingRadius=function(){this.boundingRadius=this.radius+this.length/2};r.prototype.updateArea=function(){this.area=Math.PI*this.radius*this.radius+this.radius*2*this.length};i=u.create();r.prototype.computeAABB=function(n,t,r){var f=this.radius;u.set(i,this.length/2,0);r!==0&&u.rotate(i,i,r);u.set(n.upperBound,Math.max(i[0]+f,-i[0]+f),Math.max(i[1]+f,-i[1]+f));u.set(n.lowerBound,Math.min(i[0]-f,-i[0]-f),Math.min(i[1]-f,-i[1]-f));u.add(n.lowerBound,n.lowerBound,t);u.add(n.upperBound,n.upperBound,t)}},{"../math/vec2":31,"./Shape":45}],38:[function(n,t){function i(n){this.radius=n||1;u.call(this,u.CIRCLE)}var u=n("./Shape"),r=n("../math/vec2");t.exports=i;i.prototype=new u;i.prototype.constructor=i;i.prototype.computeMomentOfInertia=function(n){var t=this.radius;return n*t*t/2};i.prototype.updateBoundingRadius=function(){this.boundingRadius=this.radius};i.prototype.updateArea=function(){this.area=Math.PI*this.radius*this.radius};i.prototype.computeAABB=function(n,t){var i=this.radius;r.set(n.upperBound,i,i);r.set(n.lowerBound,-i,-i);t&&(r.add(n.lowerBound,n.lowerBound,t),r.add(n.upperBound,n.upperBound,t))}},{"../math/vec2":31,"./Shape":45}],39:[function(n,t){function r(n,t){var e,o,r;for(this.vertices=[],this.axes=[],r=0;r<n.length;r++)e=i.create(),i.copy(e,n[r]),this.vertices.push(e);if(t)for(r=0;r<t.length;r++)o=i.create(),i.copy(o,t[r]),this.axes.push(o);else for(r=0;r<n.length;r++){var s=n[r],h=n[(r+1)%n.length],f=i.create();i.sub(f,h,s);i.rotate90cw(f,f);i.normalize(f,f);this.axes.push(f)}if(this.centerOfMass=i.fromValues(0,0),this.triangles=[],this.vertices.length&&(this.updateTriangles(),this.updateCenterOfMass()),this.boundingRadius=0,u.call(this,u.CONVEX),this.updateBoundingRadius(),this.updateArea(),this.area<0)throw new Error("Convex vertices must be given in conter-clockwise winding.");}var u=n("./Shape"),i=n("../math/vec2"),o=n("../math/polyk"),b=n("poly-decomp"),f,e;t.exports=r;r.prototype=new u;r.prototype.constructor=r;f=i.create();e=i.create();r.prototype.projectOntoLocalAxis=function(n,t){for(var h,r=null,u=null,s,e,n=f,o=0;o<this.vertices.length;o++)s=this.vertices[o],e=i.dot(s,n),(r===null||e>r)&&(r=e),(u===null||e<u)&&(u=e);u>r&&(h=u,u=r,r=h);i.set(t,u,r)};r.prototype.projectOntoWorldAxis=function(n,t,r,u){var f=e,o;this.projectOntoLocalAxis(n,u);r!==0?i.rotate(f,n,r):f=n;o=i.dot(t,f);i.set(u,u[0]+o,u[1]+o)};r.prototype.updateTriangles=function(){var i,r,t,n;for(this.triangles.length=0,i=[],n=0;n<this.vertices.length;n++)r=this.vertices[n],i.push(r[0],r[1]);for(t=o.Triangulate(i),n=0;n<t.length;n+=3){var u=t[n],f=t[n+1],e=t[n+2];this.triangles.push([u,f,e])}};var s=i.create(),h=i.create(),c=i.create(),l=i.create(),a=i.create(),v=i.create(),y=i.create(),p=i.create(),w=i.create();r.prototype.updateCenterOfMass=function(){var b=this.triangles,u=this.vertices,n=this.centerOfMass,k=s,it=w,d=c,g=l,nt=a,rt=v,ut=y,ft=p,tt=h,f,t,o;for(i.set(n,0,0),f=0,t=0;t!==b.length;t++){var e=b[t],d=u[e[0]],g=u[e[1]],nt=u[e[2]];i.centroid(k,d,g,nt);o=r.triangleArea(d,g,nt);f+=o;i.scale(tt,k,o);i.add(n,n,tt)}i.scale(n,n,1/f)};r.prototype.computeMomentOfInertia=function(n){for(var f=0,e=0,o=this.vertices.length,s=o-1,t=0;t<o;s=t,t++){var r=this.vertices[s],u=this.vertices[t],h=Math.abs(i.crossLength(r,u)),c=i.dot(u,u)+i.dot(u,r)+i.dot(r,r);f+=h*c;e+=h}return n/6*(f/e)};r.prototype.updateBoundingRadius=function(){for(var r,u=this.vertices,n=0,t=0;t!==u.length;t++)r=i.squaredLength(u[t]),r>n&&(n=r);this.boundingRadius=Math.sqrt(n)};r.triangleArea=function(n,t,i){return((t[0]-n[0])*(i[1]-n[1])-(i[0]-n[0])*(t[1]-n[1]))*.5};r.prototype.updateArea=function(){var i,n,t;for(this.updateTriangles(),this.area=0,i=this.triangles,n=this.vertices,t=0;t!==i.length;t++){var u=i[t],f=n[u[0]],e=n[u[1]],o=n[u[2]],s=r.triangleArea(f,e,o);this.area+=s}};r.prototype.computeAABB=function(n,t,i){n.setFromPoints(this.vertices,t,i,0)}},{"../math/polyk":30,"../math/vec2":31,"./Shape":45,"poly-decomp":5}],40:[function(n,t){function i(n,t){var f,i;if(t=u.defaults(t,{maxValue:null,minValue:null,elementWidth:.1}),t.minValue===null||t.maxValue===null)for(t.maxValue=n[0],t.minValue=n[0],f=0;f!==n.length;f++)i=n[f],i>t.maxValue&&(t.maxValue=i),i<t.minValue&&(t.minValue=i);this.data=n;this.maxValue=t.maxValue;this.minValue=t.minValue;this.elementWidth=t.elementWidth;r.call(this,r.HEIGHTFIELD)}var r=n("./Shape"),f=n("../math/vec2"),u=n("../utils/Utils");t.exports=i;i.prototype=new r;i.prototype.constructor=i;i.prototype.computeMomentOfInertia=function(){return Number.MAX_VALUE};i.prototype.updateBoundingRadius=function(){this.boundingRadius=Number.MAX_VALUE};i.prototype.updateArea=function(){for(var t=this.data,i=0,n=0;n<t.length-1;n++)i+=(t[n]+t[n+1])/2*this.elementWidth;this.area=i};i.prototype.computeAABB=function(n,t){n.upperBound[0]=this.elementWidth*this.data.length+t[0];n.upperBound[1]=this.maxValue+t[1];n.lowerBound[0]=t[0];n.lowerBound[1]=-Number.MAX_VALUE}},{"../math/vec2":31,"../utils/Utils":50,"./Shape":45}],41:[function(n,t){function i(n){this.length=n||1;f.call(this,f.LINE)}var f=n("./Shape"),r=n("../math/vec2"),u;t.exports=i;i.prototype=new f;i.prototype.constructor=i;i.prototype.computeMomentOfInertia=function(n){return n*Math.pow(this.length,2)/12};i.prototype.updateBoundingRadius=function(){this.boundingRadius=this.length/2};u=[r.create(),r.create()];i.prototype.computeAABB=function(n,t,i){var f=this.length/2;r.set(u[0],-f,0);r.set(u[1],f,0);n.setFromPoints(u,t,i,0)}},{"../math/vec2":31,"./Shape":45}],42:[function(n,t){function i(){r.call(this,r.PARTICLE)}var r=n("./Shape"),u=n("../math/vec2");t.exports=i;i.prototype=new r;i.prototype.constructor=i;i.prototype.computeMomentOfInertia=function(){return 0};i.prototype.updateBoundingRadius=function(){this.boundingRadius=0};i.prototype.computeAABB=function(n,t){u.copy(n.lowerBound,t);u.copy(n.upperBound,t)}},{"../math/vec2":31,"./Shape":45}],43:[function(n,t){function i(){r.call(this,r.PLANE)}var r=n("./Shape"),u=n("../math/vec2"),f=n("../utils/Utils");t.exports=i;i.prototype=new r;i.prototype.constructor=i;i.prototype.computeMomentOfInertia=function(){return 0};i.prototype.updateBoundingRadius=function(){this.boundingRadius=Number.MAX_VALUE};i.prototype.computeAABB=function(n,t,i){var f=0,r=u.set;typeof i=="number"&&(f=i%(2*Math.PI));f===0?(r(n.lowerBound,-Number.MAX_VALUE,-Number.MAX_VALUE),r(n.upperBound,Number.MAX_VALUE,0)):f===Math.PI/2?(r(n.lowerBound,0,-Number.MAX_VALUE),r(n.upperBound,Number.MAX_VALUE,Number.MAX_VALUE)):f===Math.PI?(r(n.lowerBound,-Number.MAX_VALUE,0),r(n.upperBound,Number.MAX_VALUE,Number.MAX_VALUE)):f===3*Math.PI/2?(r(n.lowerBound,-Number.MAX_VALUE,-Number.MAX_VALUE),r(n.upperBound,0,Number.MAX_VALUE)):(r(n.lowerBound,-Number.MAX_VALUE,-Number.MAX_VALUE),r(n.upperBound,Number.MAX_VALUE,Number.MAX_VALUE));u.add(n.lowerBound,n.lowerBound,t);u.add(n.upperBound,n.upperBound,t)};i.prototype.updateArea=function(){this.area=Number.MAX_VALUE}},{"../math/vec2":31,"../utils/Utils":50,"./Shape":45}],44:[function(n,t){function r(n,t){this.width=n||1;this.height=t||1;var r=[i.fromValues(-n/2,-t/2),i.fromValues(n/2,-t/2),i.fromValues(n/2,t/2),i.fromValues(-n/2,t/2)],e=[i.fromValues(1,0),i.fromValues(0,1)];u.call(this,r,e);this.type=f.RECTANGLE}var i=n("../math/vec2"),f=n("./Shape"),u=n("./Convex");t.exports=r;r.prototype=new u([]);r.prototype.constructor=r;r.prototype.computeMomentOfInertia=function(n){var t=this.width,i=this.height;return n*(i*i+t*t)/12};r.prototype.updateBoundingRadius=function(){var n=this.width,t=this.height;this.boundingRadius=Math.sqrt(n*n+t*t)/2};var e=i.create(),o=i.create(),s=i.create(),h=i.create();r.prototype.computeAABB=function(n,t,i){n.setFromPoints(this.vertices,t,i,0)};r.prototype.updateArea=function(){this.area=this.width*this.height}},{"../math/vec2":31,"./Convex":39,"./Shape":45}],45:[function(n,t){function i(n){this.type=n;this.id=i.idCounter++;this.boundingRadius=0;this.collisionGroup=1;this.collisionResponse=!0;this.collisionMask=1;n&&this.updateBoundingRadius();this.material=null;this.area=0;this.sensor=!1;this.updateArea()}t.exports=i;i.idCounter=0;i.CIRCLE=1;i.PARTICLE=2;i.PLANE=4;i.CONVEX=8;i.LINE=16;i.RECTANGLE=32;i.CAPSULE=64;i.HEIGHTFIELD=128;i.prototype.computeMomentOfInertia=function(){throw new Error("Shape.computeMomentOfInertia is not implemented in this Shape...");};i.prototype.updateBoundingRadius=function(){throw new Error("Shape.updateBoundingRadius is not implemented in this Shape...");};i.prototype.updateArea=function(){};i.prototype.computeAABB=function(){}},{}],46:[function(n,t){function i(n){u.call(this,n,u.GS);n=n||{};this.iterations=n.iterations||10;this.tolerance=n.tolerance||1e-10;this.arrayStep=30;this.lambda=new r.ARRAY_TYPE(this.arrayStep);this.Bs=new r.ARRAY_TYPE(this.arrayStep);this.invCs=new r.ARRAY_TYPE(this.arrayStep);this.useZeroRHS=!1;this.frictionIterations=0;this.usedIterations=0}function o(n){for(var t=n.length;t--;)n[t]=0}var f=n("../math/vec2"),u=n("./Solver"),r=n("../utils/Utils"),e=n("../equations/FrictionEquation");t.exports=i;i.prototype=new u;i.prototype.constructor=i;i.prototype.solve=function(n,t){var s,v,u,h,b,y,w,d,k;this.sortEquations();var l=0,et=this.iterations,rt=this.frictionIterations,a=this.equations,c=a.length,ut=Math.pow(this.tolerance*c,2),g=t.bodies,nt=t.bodies.length,ot=f.add,st=f.set,ft=this.useZeroRHS,p=this.lambda;if(this.usedIterations=0,c)for(u=0;u!==nt;u++)b=g[u],b.updateSolveMassProperties();p.length<c&&(p=this.lambda=new r.ARRAY_TYPE(c+this.arrayStep),this.Bs=new r.ARRAY_TYPE(c+this.arrayStep),this.invCs=new r.ARRAY_TYPE(c+this.arrayStep));o(p);var tt=this.invCs,it=this.Bs,p=this.lambda;for(u=0;u!==a.length;u++)s=a[u],(s.timeStep!==n||s.needsUpdate)&&(s.timeStep=n,s.update()),it[u]=s.computeB(s.a,s.b,n),tt[u]=s.computeInvC(s.epsilon);if(c!==0){for(u=0;u!==nt;u++)b=g[u],b.resetConstraintVelocity();if(rt){for(l=0;l!==rt;l++){for(v=0,h=0;h!==c;h++)s=a[h],k=i.iterateEquation(h,s,s.epsilon,it,tt,p,ft,n,l),v+=Math.abs(k);if(this.usedIterations++,v*v<=ut)break}for(i.updateMultipliers(a,p,1/n),h=0;h!==c;h++)if(y=a[h],y instanceof e){for(w=0,d=0;d!==y.contactEquations.length;d++)w+=y.contactEquations[d].multiplier;w*=y.frictionCoefficient/y.contactEquations.length;y.maxForce=w;y.minForce=-w}}for(l=0;l!==et;l++){for(v=0,h=0;h!==c;h++)s=a[h],k=i.iterateEquation(h,s,s.epsilon,it,tt,p,ft,n,l),v+=Math.abs(k);if(this.usedIterations++,v*v<=ut)break}for(u=0;u!==nt;u++)g[u].addConstraintVelocity();i.updateMultipliers(a,p,1/n)}};i.updateMultipliers=function(n,t,i){for(var r=n.length;r--;)n[r].multiplier=t[r]*i};i.iterateEquation=function(n,t,i,r,u,f,e,o){var l=r[n],y=u[n],h=f[n],p=t.computeGWlambda(),a=t.maxForce,v=t.minForce,s,c;return e&&(l=0),s=y*(l-p-i*h),c=h+s,c<v*o?s=v*o-h:c>a*o&&(s=a*o-h),f[n]+=s,t.addToWlambda(s),s}},{"../equations/FrictionEquation":24,"../math/vec2":31,"../utils/Utils":50,"./Solver":47}],47:[function(n,t){function i(n,t){n=n||{};u.call(this);this.type=t;this.equations=[];this.equationSortFunction=n.equationSortFunction||!1}var f=n("../utils/Utils"),u=n("../events/EventEmitter"),r;t.exports=i;i.prototype=new u;i.prototype.constructor=i;i.prototype.solve=function(){throw new Error("Solver.solve should be implemented by subclasses!");};r={bodies:[]};i.prototype.solveIsland=function(n,t){this.removeAllEquations();t.equations.length&&(this.addEquations(t.equations),r.bodies.length=0,t.getBodies(r.bodies),r.bodies.length&&this.solve(n,r))};i.prototype.sortEquations=function(){this.equationSortFunction&&this.equations.sort(this.equationSortFunction)};i.prototype.addEquation=function(n){n.enabled&&this.equations.push(n)};i.prototype.addEquations=function(n){for(var i,t=0,r=n.length;t!==r;t++)i=n[t],i.enabled&&this.equations.push(i)};i.prototype.removeEquation=function(n){var t=this.equations.indexOf(n);t!==-1&&this.equations.splice(t,1)};i.prototype.removeAllEquations=function(){this.equations.length=0};i.GS=1;i.ISLAND=2},{"../events/EventEmitter":27,"../utils/Utils":50}],48:[function(n,t){function i(){this.overlappingShapesLastState=new r;this.overlappingShapesCurrentState=new r;this.recordPool=[];this.tmpDict=new r;this.tmpArray1=[]}function u(n,t,i,r){this.shapeA=t;this.shapeB=r;this.bodyA=n;this.bodyB=i}var r=n("./TupleDictionary"),f=n("./Utils");t.exports=i;i.prototype.tick=function(){for(var n=this.overlappingShapesLastState,t=this.overlappingShapesCurrentState,i=n.keys.length;i--;){var r=n.keys[i],u=n.getByKey(r),f=t.getByKey(r);u&&!f&&this.recordPool.push(u)}n.reset();n.copy(t);t.reset()};i.prototype.setOverlapping=function(n,t,i,r){var o=this.overlappingShapesLastState,e=this.overlappingShapesCurrentState,f;e.get(t.id,r.id)||(this.recordPool.length?(f=this.recordPool.pop(),f.set(n,t,i,r)):f=new u(n,t,i,r),e.set(t.id,r.id,f))};i.prototype.getNewOverlaps=function(n){return this.getDiff(this.overlappingShapesLastState,this.overlappingShapesCurrentState,n)};i.prototype.getEndOverlaps=function(n){return this.getDiff(this.overlappingShapesCurrentState,this.overlappingShapesLastState,n)};i.prototype.bodiesAreOverlapping=function(n,t){for(var r=this.overlappingShapesCurrentState,u=r.keys.length,f,i;u--;)if(f=r.keys[u],i=r.data[f],i.bodyA===n&&i.bodyB===t||i.bodyA===t&&i.bodyB===n)return!0;return!1};i.prototype.getDiff=function(n,t,i){var i=i||[],s=n,u=t,f,r,e,o;for(i.length=0,f=u.keys.length;f--;){if(r=u.keys[f],e=u.data[r],!e)throw new Error("Key "+r+" had no data!");o=s.data[r];o||i.push(e)}return i};i.prototype.isNewOverlap=function(n,t){var i=n.id|0,r=t.id|0,u=this.overlappingShapesLastState,f=this.overlappingShapesCurrentState;return!!!u.get(i,r)&&!!f.get(i,r)};i.prototype.getNewBodyOverlaps=function(n){this.tmpArray1.length=0;var t=this.getNewOverlaps(this.tmpArray1);return this.getBodyDiff(t,n)};i.prototype.getEndBodyOverlaps=function(n){this.tmpArray1.length=0;var t=this.getEndOverlaps(this.tmpArray1);return this.getBodyDiff(t,n)};i.prototype.getBodyDiff=function(n,t){var r,u,i;for(t=t||[],r=this.tmpDict,u=n.length;u--;)i=n[u],r.set(i.bodyA.id|0,i.bodyB.id|0,i);for(u=r.keys.length;u--;)i=r.getByKey(r.keys[u]),i&&t.push(i.bodyA,i.bodyB);return r.reset(),t};u.prototype.set=function(n,t,i,r){u.call(this,n,t,i,r)}},{"./TupleDictionary":49,"./Utils":50}],49:[function(n,t){function i(){this.data={};this.keys=[]}var r=n("./Utils");t.exports=i;i.prototype.getKey=function(n,t){return(n=n|0,t=t|0,(n|0)==(t|0))?-1:((n|0)>(t|0)?n<<16|t&65535:t<<16|n&65535)|0};i.prototype.getByKey=function(n){return n=n|0,this.data[n]};i.prototype.get=function(n,t){return this.data[this.getKey(n,t)]};i.prototype.set=function(n,t,i){if(!i)throw new Error("No data!");var r=this.getKey(n,t);return this.data[r]||this.keys.push(r),this.data[r]=i,r};i.prototype.reset=function(){for(var i=this.data,n=this.keys,t=n.length;t--;)delete i[n[t]];n.length=0};i.prototype.copy=function(n){var t,i;for(this.reset(),r.appendArray(this.keys,n.keys),t=n.keys.length;t--;)i=n.keys[t],this.data[i]=n.data[i]}},{"./Utils":50}],50:[function(n,t){function i(){}t.exports=i;i.appendArray=function(n,t){if(t.length<15e4)n.push.apply(n,t);else for(var i=0,r=t.length;i!==r;++i)n.push(t[i])};i.splice=function(n,t,i){i=i||1;for(var r=t,u=n.length-i;r<u;r++)n[r]=n[r+i];n.length=u};i.ARRAY_TYPE=typeof P2_ARRAY_TYPE!="undefined"?P2_ARRAY_TYPE:typeof Float32Array!="undefined"?Float32Array:Array;i.extend=function(n,t){for(var i in t)n[i]=t[i]};i.defaults=function(n,t){n=n||{};for(var i in t)i in n||(n[i]=t[i]);return n}},{}],51:[function(n,t){function r(){this.equations=[];this.bodies=[]}var u=n("../objects/Body"),i;t.exports=r;r.prototype.reset=function(){this.equations.length=this.bodies.length=0};i=[];r.prototype.getBodies=function(n){var u=n||[],f=this.equations,r,t;for(i.length=0,r=0;r!==f.length;r++)t=f[r],i.indexOf(t.bodyA.id)===-1&&(u.push(t.bodyA),i.push(t.bodyA.id)),i.indexOf(t.bodyB.id)===-1&&(u.push(t.bodyB),i.push(t.bodyB.id));return u};r.prototype.wantsToSleep=function(){for(var t,n=0;n<this.bodies.length;n++)if(t=this.bodies[n],t.type===u.DYNAMIC&&!t.wantsToSleep)return!1;return!0};r.prototype.sleep=function(){for(var t,n=0;n<this.bodies.length;n++)t=this.bodies[n],t.sleep();return!0}},{"../objects/Body":32}],52:[function(n,t){function i(){this._nodePool=[];this._islandPool=[];this.equations=[];this.islands=[];this.nodes=[];this.queue=[]}var e=n("../math/vec2"),u=n("./Island"),f=n("./IslandNode"),r=n("../objects/Body");t.exports=i;i.getUnvisitedNode=function(n){for(var t,u=n.length,i=0;i!==u;i++)if(t=n[i],!t.visited&&t.body.type===r.DYNAMIC)return t;return!1};i.prototype.visit=function(n,t,i){var f,r,u;for(t.push(n.body),f=n.equations.length,r=0;r!==f;r++)u=n.equations[r],i.indexOf(u)===-1&&i.push(u)};i.prototype.bfs=function(n,t,u){var f=this.queue,o,e;for(f.length=0,f.push(n),n.visited=!0,this.visit(n,t,u);f.length;)for(o=f.pop();e=i.getUnvisitedNode(o.neighbors);)e.visited=!0,this.visit(e,t,u),e.body.type===r.DYNAMIC&&f.push(e)};i.prototype.split=function(n){for(var o=n.bodies,t=this.nodes,y=this.equations,e,h,c,s,p,r;t.length;)this._nodePool.push(t.pop());for(e=0;e!==o.length;e++)this._nodePool.length?(h=this._nodePool.pop(),h.reset(),h.body=o[e],t.push(h)):t.push(new f(o[e]));for(c=0;c!==y.length;c++){var l=y[c],e=o.indexOf(l.bodyA),w=o.indexOf(l.bodyB),a=t[e],v=t[w];a.neighbors.push(v);v.neighbors.push(a);a.equations.push(l);v.equations.push(l)}for(s=this.islands;s.length;)r=s.pop(),r.reset(),this._islandPool.push(r);while(p=i.getUnvisitedNode(t))r=this._islandPool.length?this._islandPool.pop():new u,this.bfs(p,r.bodies,r.equations),s.push(r);return s}},{"../math/vec2":31,"../objects/Body":32,"./Island":51,"./IslandNode":53}],53:[function(n,t){function i(n){this.body=n;this.neighbors=[];this.equations=[];this.visited=!1}t.exports=i;i.prototype.reset=function(){this.equations.length=0;this.neighbors.length=0;this.visited=!1;this.body=null}},{}],54:[function(n,t){function r(n){y.apply(this);n=n||{};this.springs=[];this.bodies=[];this.disabledBodyCollisionPairs=[];this.solver=n.solver||new p;this.narrowphase=new it(this);this.islandManager=new ut;this.gravity=i.fromValues(0,-9.78);n.gravity&&i.copy(this.gravity,n.gravity);this.frictionGravity=i.length(this.gravity)||10;this.useWorldGravityAsFrictionGravity=!0;this.useFrictionGravityOnZeroGravity=!0;this.doProfiling=n.doProfiling||!1;this.lastStepTime=0;this.broadphase=n.broadphase||new tt;this.broadphase.setWorld(this);this.constraints=[];this.defaultMaterial=new g;this.defaultContactMaterial=new nt(this.defaultMaterial,this.defaultMaterial);this.lastTimeStep=1/60;this.applySpringForces=!0;this.applyDamping=!0;this.applyGravity=!0;this.solveConstraints=!0;this.contactMaterials=[];this.time=0;this.stepping=!1;this.bodiesToBeRemoved=[];this.fixedStepTime=0;this.islandSplit=typeof n.islandSplit!="undefined"?!!n.islandSplit:!1;this.emitImpactEvent=!0;this._constraintIdCounter=0;this._bodyIdCounter=0;this.postStepEvent={type:"postStep"};this.addBodyEvent={type:"addBody",body:null};this.removeBodyEvent={type:"removeBody",body:null};this.addSpringEvent={type:"addSpring",spring:null};this.impactEvent={type:"impact",bodyA:null,bodyB:null,shapeA:null,shapeB:null,contactEquation:null};this.postBroadphaseEvent={type:"postBroadphase",pairs:null};this.sleepMode=r.NO_SLEEPING;this.beginContactEvent={type:"beginContact",shapeA:null,shapeB:null,bodyA:null,bodyB:null,contactEquations:[]};this.endContactEvent={type:"endContact",shapeA:null,shapeB:null,bodyA:null,bodyB:null};this.preSolveEvent={type:"preSolve",contactEquations:null,frictionEquations:null};this.overlappingShapesLastState={keys:[]};this.overlappingShapesCurrentState={keys:[]};this.overlapKeeper=new rt}var p=n("../solver/GSSolver"),lt=n("../solver/Solver"),at=n("../collision/NaiveBroadphase"),s=n("../collision/Ray"),i=n("../math/vec2"),w=n("../shapes/Circle"),vt=n("../shapes/Rectangle"),b=n("../shapes/Convex"),yt=n("../shapes/Line"),k=n("../shapes/Plane"),d=n("../shapes/Capsule"),v=n("../shapes/Particle"),y=n("../events/EventEmitter"),u=n("../objects/Body"),pt=n("../shapes/Shape"),wt=n("../objects/LinearSpring"),g=n("../material/Material"),nt=n("../material/ContactMaterial"),bt=n("../constraints/DistanceConstraint"),kt=n("../constraints/Constraint"),dt=n("../constraints/LockConstraint"),gt=n("../constraints/RevoluteConstraint"),ni=n("../constraints/PrismaticConstraint"),ti=n("../constraints/GearConstraint"),ii=n("../../package.json"),ri=n("../collision/Broadphase"),tt=n("../collision/SAPBroadphase"),it=n("../collision/Narrowphase"),f=n("../utils/Utils"),rt=n("../utils/OverlapKeeper"),ut=n("./IslandManager"),ui=n("../objects/RotationalSpring"),a,c,l;t.exports=r;typeof performance=="undefined"&&(performance={});performance.now||(a=Date.now(),performance.timing&&performance.timing.navigationStart&&(a=performance.timing.navigationStart),performance.now=function(){return Date.now()-a});r.prototype=new Object(y.prototype);r.prototype.constructor=r;r.NO_SLEEPING=1;r.BODY_SLEEPING=2;r.ISLAND_SLEEPING=4;r.prototype.addConstraint=function(n){this.constraints.push(n)};r.prototype.addContactMaterial=function(n){this.contactMaterials.push(n)};r.prototype.removeContactMaterial=function(n){var t=this.contactMaterials.indexOf(n);t!==-1&&f.splice(this.contactMaterials,t,1)};r.prototype.getContactMaterial=function(n,t){for(var i,u=this.contactMaterials,r=0,f=u.length;r!==f;r++)if(i=u[r],i.materialA.id===n.id&&i.materialB.id===t.id||i.materialA.id===t.id&&i.materialB.id===n.id)return i;return!1};r.prototype.removeConstraint=function(n){var t=this.constraints.indexOf(n);t!==-1&&f.splice(this.constraints,t,1)};var fi=i.create(),ei=i.create(),oi=i.create(),si=i.create(),ft=i.create(),et=i.create(),ot=i.create(),e=i.fromValues(0,0),o=i.fromValues(0,0),hi=i.fromValues(0,0),h=i.fromValues(0,0);r.prototype.step=function(n,t,r){var e,l,s,a,c,o,f;if(r=r||10,t=t||0,t===0)this.internalStep(n),this.time+=n;else{for(e=Math.floor((this.time+t)/n)-Math.floor(this.time/n),e=Math.min(e,r),l=performance.now(),s=0;s!==e;s++)if(this.internalStep(n),performance.now()-l>n*1e3)break;for(this.time+=t,a=this.time%n,c=a/n,o=0;o!==this.bodies.length;o++)f=this.bodies[o],f.type!==u.STATIC&&f.sleepState!==u.SLEEPING?(i.sub(h,f.position,f.previousPosition),i.scale(h,h,c),i.add(f.interpolatedPosition,f.position,h),f.interpolatedAngle=f.angle+(f.angle-f.previousAngle)*c):(i.copy(f.interpolatedPosition,f.position),f.interpolatedAngle=f.angle)}};c=[];r.prototype.internalStep=function(n){var at,vt,ni,h,e,g,tt,o,ti,it,rt,ut,ii,ri,wt,st,l,ct,lt,nt,a,b,k,ht,t;this.stepping=!0;var fi=this,bt=this.doProfiling,ei=this.springs.length,oi=this.springs,v=this.bodies,si=this.gravity,d=this.solver,y=this.bodies.length,hi=this.broadphase,s=this.narrowphase,p=this.constraints,kt,dt,pi=ft,wi=et,gt=ot,bi=i.scale,ci=i.add,ki=i.rotate,w=this.islandManager;if(this.overlapKeeper.tick(),this.lastTimeStep=n,bt&&(kt=performance.now()),this.useWorldGravityAsFrictionGravity&&(at=i.length(this.gravity),at===0&&this.useFrictionGravityOnZeroGravity||(this.frictionGravity=at)),this.applyGravity)for(t=0;t!==y;t++)(h=v[t],vt=h.force,h.type===u.DYNAMIC&&h.sleepState!==u.SLEEPING)&&(i.scale(gt,si,h.mass*h.gravityScale),ci(vt,vt,gt));if(this.applySpringForces)for(t=0;t!==ei;t++)ni=oi[t],ni.applyForce();if(this.applyDamping)for(t=0;t!==y;t++)h=v[t],h.type===u.DYNAMIC&&h.applyDamping(n);for(e=hi.getCollisionPairs(this),g=this.disabledBodyCollisionPairs,t=g.length-2;t>=0;t-=2)for(o=e.length-2;o>=0;o-=2)(g[t]===e[o]&&g[t+1]===e[o+1]||g[t+1]===e[o]&&g[t]===e[o+1])&&e.splice(o,2);for(nt=p.length,t=0;t!==nt;t++)if(tt=p[t],!tt.collideConnected)for(o=e.length-2;o>=0;o-=2)(tt.bodyA===e[o]&&tt.bodyB===e[o+1]||tt.bodyB===e[o]&&tt.bodyA===e[o+1])&&e.splice(o,2);for(this.postBroadphaseEvent.pairs=e,this.emit(this.postBroadphaseEvent),s.reset(this),t=0,ti=e.length;t!==ti;t+=2)for(it=e[t],rt=e[t+1],ut=0,ii=it.shapes.length;ut!==ii;ut++){var yt=it.shapes[ut],li=it.shapeOffsets[ut],ai=it.shapeAngles[ut];for(l=0,ri=rt.shapes.length;l!==ri;l++){var pt=rt.shapes[l],vi=rt.shapeOffsets[l],yi=rt.shapeAngles[l],ui=this.defaultContactMaterial;yt.material&&pt.material&&(wt=this.getContactMaterial(yt.material,pt.material),wt&&(ui=wt));this.runNarrowphase(s,it,yt,li,ai,rt,pt,vi,yi,ui,this.frictionGravity)}}for(t=0;t!==y;t++)a=v[t],a._wakeUpAfterNarrowphase&&(a.wakeUp(),a._wakeUpAfterNarrowphase=!1);if(this.has("endContact"))for(this.overlapKeeper.getEndOverlaps(c),st=this.endContactEvent,l=c.length;l--;)ct=c[l],st.shapeA=ct.shapeA,st.shapeB=ct.shapeB,st.bodyA=ct.bodyA,st.bodyB=ct.bodyB,this.emit(st);for(lt=this.preSolveEvent,lt.contactEquations=s.contactEquations,lt.frictionEquations=s.frictionEquations,this.emit(lt),nt=p.length,t=0;t!==nt;t++)p[t].update();if(s.contactEquations.length||s.frictionEquations.length||p.length)if(this.islandSplit){for(w.equations.length=0,f.appendArray(w.equations,s.contactEquations),f.appendArray(w.equations,s.frictionEquations),t=0;t!==nt;t++)f.appendArray(w.equations,p[t].equations);for(w.split(this),t=0;t!==w.islands.length;t++)ht=w.islands[t],ht.equations.length&&d.solveIsland(n,ht)}else{for(d.addEquations(s.contactEquations),d.addEquations(s.frictionEquations),t=0;t!==nt;t++)d.addEquations(p[t].equations);this.solveConstraints&&d.solve(n,this);d.removeAllEquations()}for(t=0;t!==y;t++)a=v[t],a.sleepState!==u.SLEEPING&&a.type!==u.STATIC&&a.integrate(n);for(t=0;t!==y;t++)v[t].setZeroForce();if(bt&&(dt=performance.now(),fi.lastStepTime=dt-kt),this.emitImpactEvent&&this.has("impact"))for(b=this.impactEvent,t=0;t!==s.contactEquations.length;t++)k=s.contactEquations[t],k.firstImpact&&(b.bodyA=k.bodyA,b.bodyB=k.bodyB,b.shapeA=k.shapeA,b.shapeB=k.shapeB,b.contactEquation=k,this.emit(b));if(this.sleepMode===r.BODY_SLEEPING)for(t=0;t!==y;t++)v[t].sleepTick(this.time,!1,n);else if(this.sleepMode===r.ISLAND_SLEEPING&&this.islandSplit){for(t=0;t!==y;t++)v[t].sleepTick(this.time,!0,n);for(t=0;t<this.islandManager.islands.length;t++)ht=this.islandManager.islands[t],ht.wantsToSleep()&&ht.sleep()}if(this.stepping=!1,this.bodiesToBeRemoved.length){for(t=0;t!==this.bodiesToBeRemoved.length;t++)this.removeBody(this.bodiesToBeRemoved[t]);this.bodiesToBeRemoved.length=0}this.emit(this.postStepEvent)};r.prototype.runNarrowphase=function(n,t,r,f,s,h,c,l,a,v,y){var g,nt,rt,k,b,tt,ut,d,ft,et,ot,st,p,w,it;if((r.collisionGroup&c.collisionMask)!=0&&(c.collisionGroup&r.collisionMask)!=0&&(i.rotate(e,f,t.angle),i.rotate(o,l,h.angle),i.add(e,e,t.position),i.add(o,o,h.position),g=s+t.angle,nt=a+h.angle,n.enableFriction=v.friction>0,n.frictionCoefficient=v.friction,rt=t.type===u.STATIC||t.type===u.KINEMATIC?h.mass:h.type===u.STATIC||h.type===u.KINEMATIC?t.mass:t.mass*h.mass/(t.mass+h.mass),n.slipForce=v.friction*y*rt,n.restitution=v.restitution,n.surfaceVelocity=v.surfaceVelocity,n.frictionStiffness=v.frictionStiffness,n.frictionRelaxation=v.frictionRelaxation,n.stiffness=v.stiffness,n.relaxation=v.relaxation,n.contactSkinSize=v.contactSkinSize,n.enabledEquations=t.collisionResponse&&h.collisionResponse&&r.collisionResponse&&c.collisionResponse,k=n[r.type|c.type],b=0,k&&(tt=r.sensor||c.sensor,ut=n.frictionEquations.length,b=r.type<c.type?k.call(n,t,r,e,g,h,c,o,nt,tt):k.call(n,h,c,o,nt,t,r,e,g,tt),d=n.frictionEquations.length-ut,b))){if(t.allowSleep&&t.type===u.DYNAMIC&&t.sleepState===u.SLEEPING&&h.sleepState===u.AWAKE&&h.type!==u.STATIC&&(ft=i.squaredLength(h.velocity)+Math.pow(h.angularVelocity,2),et=Math.pow(h.sleepSpeedLimit,2),ft>=et*2&&(t._wakeUpAfterNarrowphase=!0)),h.allowSleep&&h.type===u.DYNAMIC&&h.sleepState===u.SLEEPING&&t.sleepState===u.AWAKE&&t.type!==u.STATIC&&(ot=i.squaredLength(t.velocity)+Math.pow(t.angularVelocity,2),st=Math.pow(t.sleepSpeedLimit,2),ot>=st*2&&(h._wakeUpAfterNarrowphase=!0)),this.overlapKeeper.setOverlapping(t,r,h,c),this.has("beginContact")&&this.overlapKeeper.isNewOverlap(r,c)){if(p=this.beginContactEvent,p.shapeA=r,p.shapeB=c,p.bodyA=t,p.bodyB=h,p.contactEquations.length=0,typeof b=="number")for(w=n.contactEquations.length-b;w<n.contactEquations.length;w++)p.contactEquations.push(n.contactEquations[w]);this.emit(p)}if(typeof b=="number"&&d>1)for(w=n.frictionEquations.length-d;w<n.frictionEquations.length;w++)it=n.frictionEquations[w],it.setSlipForce(it.getSlipForce()/d)}};r.prototype.addSpring=function(n){this.springs.push(n);this.addSpringEvent.spring=n;this.emit(this.addSpringEvent)};r.prototype.removeSpring=function(n){var t=this.springs.indexOf(n);t!==-1&&f.splice(this.springs,t,1)};r.prototype.addBody=function(n){this.bodies.indexOf(n)===-1&&(this.bodies.push(n),n.world=this,this.addBodyEvent.body=n,this.emit(this.addBodyEvent))};r.prototype.removeBody=function(n){if(this.stepping)this.bodiesToBeRemoved.push(n);else{n.world=null;var t=this.bodies.indexOf(n);t!==-1&&(f.splice(this.bodies,t,1),this.removeBodyEvent.body=n,n.resetConstraintVelocity(),this.emit(this.removeBodyEvent))}};r.prototype.getBodyById=function(n){for(var i,r=this.bodies,t=0;t<r.length;t++)if(i=r[t],i.id===n)return i;return!1};r.prototype.disableBodyCollision=function(n,t){this.disabledBodyCollisionPairs.push(n,t)};r.prototype.enableBodyCollision=function(n,t){for(var r=this.disabledBodyCollisionPairs,i=0;i<r.length;i+=2)if(r[i]===n&&r[i+1]===t||r[i+1]===n&&r[i]===t){r.splice(i,2);return}};r.prototype.clear=function(){var t,i,u,f,n;for(this.time=0,this.fixedStepTime=0,this.solver&&this.solver.equations.length&&this.solver.removeAllEquations(),t=this.constraints,n=t.length-1;n>=0;n--)this.removeConstraint(t[n]);for(i=this.bodies,n=i.length-1;n>=0;n--)this.removeBody(i[n]);for(u=this.springs,n=u.length-1;n>=0;n--)this.removeSpring(u[n]);for(f=this.contactMaterials,n=f.length-1;n>=0;n--)this.removeContactMaterial(f[n]);r.apply(this)};r.prototype.clone=function(){var n=new r;return n.fromJSON(this.toJSON()),n};var st=i.create(),ht=i.fromValues(0,0),ct=i.fromValues(0,0);r.prototype.hitTest=function(n,t,r){var l,nt,g,tt,f,s,it,a;r=r||0;var h=new u({position:n}),c=new v,y=n,p=0,o=st,rt=ht,ut=ct;for(h.addShape(c),l=this.narrowphase,nt=[],g=0,tt=t.length;g!==tt;g++)for(f=t[g],s=0,it=f.shapes.length;s!==it;s++){var e=f.shapes[s],ft=f.shapeOffsets[s]||rt,et=f.shapeAngles[s]||0;i.rotate(o,ft,f.angle);i.add(o,o,f.position);a=et+f.angle;(e instanceof w&&l.circleParticle(f,e,o,a,h,c,y,p,!0)||e instanceof b&&l.particleConvex(h,c,y,p,f,e,o,a,!0)||e instanceof k&&l.particlePlane(h,c,y,p,f,e,o,a,!0)||e instanceof d&&l.particleCapsule(h,c,y,p,f,e,o,a,!0)||e instanceof v&&i.squaredLength(i.sub(ut,o,n))<r*r)&&nt.push(f)}return nt};r.prototype.setGlobalEquationParameters=function(n){var r,u,i,t;for(n=n||{},i=0;i!==this.constraints.length;i++)for(t=this.constraints[i],r=0;r!==t.equations.length;r++)u=t.equations[r],typeof n.stiffness!="undefined"&&(u.stiffness=n.stiffness),typeof n.relaxation!="undefined"&&(u.relaxation=n.relaxation),u.needsUpdate=!0;for(i=0;i!==this.contactMaterials.length;i++)t=this.contactMaterials[i],typeof n.stiffness!="undefined"&&(t.stiffness=n.stiffness,t.frictionStiffness=n.stiffness),typeof n.relaxation!="undefined"&&(t.relaxation=n.relaxation,t.frictionRelaxation=n.relaxation);t=this.defaultContactMaterial;typeof n.stiffness!="undefined"&&(t.stiffness=n.stiffness,t.frictionStiffness=n.stiffness);typeof n.relaxation!="undefined"&&(t.relaxation=n.relaxation,t.frictionRelaxation=n.relaxation)};r.prototype.setGlobalStiffness=function(n){this.setGlobalEquationParameters({stiffness:n})};r.prototype.setGlobalRelaxation=function(n){this.setGlobalEquationParameters({relaxation:n})};l=new s;r.prototype.raycastAll=function(n,t,i,r){return i.mode=s.ALL,i.from=n,i.to=t,i.callback=r,l.intersectWorld(this,i)};r.prototype.raycastAny=function(n,t,i,r){return i.mode=s.ANY,i.from=n,i.to=t,i.result=r,l.intersectWorld(this,i)};r.prototype.raycastClosest=function(n,t,i,r){return i.mode=s.CLOSEST,i.from=n,i.to=t,i.result=r,l.intersectWorld(this,i)}},{"../../package.json":6,"../collision/Broadphase":8,"../collision/NaiveBroadphase":10,"../collision/Narrowphase":11,"../collision/Ray":12,"../collision/SAPBroadphase":14,"../constraints/Constraint":15,"../constraints/DistanceConstraint":16,"../constraints/GearConstraint":17,"../constraints/LockConstraint":18,"../constraints/PrismaticConstraint":19,"../constraints/RevoluteConstraint":20,"../events/EventEmitter":27,"../material/ContactMaterial":28,"../material/Material":29,"../math/vec2":31,"../objects/Body":32,"../objects/LinearSpring":33,"../objects/RotationalSpring":34,"../shapes/Capsule":37,"../shapes/Circle":38,"../shapes/Convex":39,"../shapes/Line":41,"../shapes/Particle":42,"../shapes/Plane":43,"../shapes/Rectangle":44,"../shapes/Shape":45,"../solver/GSSolver":46,"../solver/Solver":47,"../utils/OverlapKeeper":48,"../utils/Utils":50,"./IslandManager":52}]},{},[36])(36)});